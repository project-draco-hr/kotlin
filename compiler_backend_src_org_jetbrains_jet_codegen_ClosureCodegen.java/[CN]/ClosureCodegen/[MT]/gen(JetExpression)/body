{
  final Pair<JvmClassName,ClassBuilder> nameAndVisitor=state.forAnonymousSubclass(fun);
  final FunctionDescriptor funDescriptor=(FunctionDescriptor)bindingContext.get(BindingContext.DECLARATION_TO_DESCRIPTOR,fun);
  cv=nameAndVisitor.getSecond();
  name=nameAndVisitor.getFirst();
  SignatureWriter signatureWriter=new SignatureWriter();
  final List<ValueParameterDescriptor> parameters=funDescriptor.getValueParameters();
  final JvmClassName funClass=getInternalClassName(funDescriptor);
  signatureWriter.visitClassType(funClass.getInternalName());
  for (  ValueParameterDescriptor parameter : parameters) {
    appendType(signatureWriter,parameter.getType(),'=');
  }
  appendType(signatureWriter,funDescriptor.getReturnType(),'=');
  signatureWriter.visitEnd();
  cv.defineClass(fun,V1_6,ACC_PUBLIC,name.getInternalName(),null,funClass.getInternalName(),new String[0]);
  cv.visitSource(fun.getContainingFile().getName(),null);
  generateBridge(name.getInternalName(),funDescriptor,fun,cv);
  captureThis=generateBody(funDescriptor,cv,(JetDeclarationWithBody)fun);
  ClassDescriptor thisDescriptor=context.getThisDescriptor();
  final Type enclosingType=thisDescriptor == null ? null : state.getInjector().getJetTypeMapper().mapType(thisDescriptor.getDefaultType(),MapTypeMode.VALUE);
  if (enclosingType == null)   captureThis=null;
  final Method constructor=generateConstructor(funClass,fun,funDescriptor);
  if (captureThis != null) {
    cv.newField(fun,ACC_FINAL,"this$0",enclosingType.getDescriptor(),null,null);
  }
  if (isConst()) {
    generateConstInstance(fun);
  }
  cv.done();
  final GeneratedAnonymousClassDescriptor answer=new GeneratedAnonymousClassDescriptor(name,constructor,captureThis,captureReceiver);
  for (  DeclarationDescriptor descriptor : closure.keySet()) {
    if (descriptor == funDescriptor) {
      continue;
    }
    if (descriptor instanceof VariableDescriptor) {
      final EnclosedValueDescriptor valueDescriptor=closure.get(descriptor);
      answer.addArg(valueDescriptor.getOuterValue());
    }
 else     if (CodegenUtil.isNamedFun(descriptor,state.getBindingContext()) && descriptor.getContainingDeclaration() instanceof FunctionDescriptor) {
      final EnclosedValueDescriptor valueDescriptor=closure.get(descriptor);
      answer.addArg(valueDescriptor.getOuterValue());
    }
  }
  return answer;
}
