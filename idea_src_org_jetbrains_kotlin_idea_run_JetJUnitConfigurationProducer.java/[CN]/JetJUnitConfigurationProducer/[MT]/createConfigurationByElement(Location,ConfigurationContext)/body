{
  if (DumbService.getInstance(location.getProject()).isDumb())   return null;
  PsiElement leaf=location.getPsiElement();
  if (!ProjectRootsUtil.isInProjectOrLibSource(leaf)) {
    return null;
  }
  if (!(leaf.getContainingFile() instanceof JetFile)) {
    return null;
  }
  JetFile jetFile=(JetFile)leaf.getContainingFile();
  if (ProjectStructureUtil.isJsKotlinModule(jetFile)) {
    return null;
  }
  JetNamedFunction function=PsiTreeUtil.getParentOfType(leaf,JetNamedFunction.class,false);
  if (function != null) {
    myElement=function;
    @SuppressWarnings("unchecked") JetElement owner=PsiTreeUtil.getParentOfType(function,JetFunction.class,JetClass.class);
    if (owner instanceof JetClass) {
      PsiClass delegate=LightClassUtil.getPsiClass((JetClass)owner);
      if (delegate != null) {
        for (        PsiMethod method : delegate.getMethods()) {
          if (method.getNavigationElement() == function) {
            Location<PsiMethod> methodLocation=PsiLocation.fromPsiElement(method);
            if (JUnitUtil.isTestMethod(methodLocation,false)) {
              RunnerAndConfigurationSettings settings=cloneTemplateConfiguration(context.getProject(),context);
              JUnitConfiguration configuration=(JUnitConfiguration)settings.getConfiguration();
              Module originalModule=configuration.getConfigurationModule().getModule();
              configuration.beMethodConfiguration(methodLocation);
              configuration.restoreOriginalModule(originalModule);
              JavaRunConfigurationExtensionManager.getInstance().extendCreatedConfiguration(configuration,location);
              return settings;
            }
            break;
          }
        }
      }
    }
  }
  JetClass jetClass=PsiTreeUtil.getParentOfType(leaf,JetClass.class,false);
  if (jetClass == null) {
    jetClass=getClassDeclarationInFile(jetFile);
  }
  if (jetClass != null) {
    myElement=jetClass;
    PsiClass delegate=LightClassUtil.getPsiClass(jetClass);
    if (delegate != null && JUnitUtil.isTestClass(delegate)) {
      RunnerAndConfigurationSettings settings=cloneTemplateConfiguration(context.getProject(),context);
      JUnitConfiguration configuration=(JUnitConfiguration)settings.getConfiguration();
      Module originalModule=configuration.getConfigurationModule().getModule();
      configuration.beClassConfiguration(delegate);
      configuration.restoreOriginalModule(originalModule);
      JavaRunConfigurationExtensionManager.getInstance().extendCreatedConfiguration(configuration,location);
      return settings;
    }
  }
  return null;
}
