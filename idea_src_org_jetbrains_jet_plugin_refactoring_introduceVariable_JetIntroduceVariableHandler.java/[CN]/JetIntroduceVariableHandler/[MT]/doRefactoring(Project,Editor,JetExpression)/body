{
  if (_expression == null) {
    showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.no.expression"));
    return;
  }
  if (_expression.getParent() instanceof JetParenthesizedExpression) {
    _expression=(JetExpression)_expression.getParent();
  }
  final JetExpression expression=_expression;
  if (expression.getParent() instanceof JetQualifiedExpression) {
    JetQualifiedExpression qualifiedExpression=(JetQualifiedExpression)expression.getParent();
    if (qualifiedExpression.getReceiverExpression() != expression) {
      showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.no.expression"));
      return;
    }
  }
 else   if (expression.getParent() instanceof JetCallElement || expression instanceof JetStatementExpression) {
    showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.no.expression"));
    return;
  }
 else   if (expression.getParent() instanceof JetOperationExpression) {
    JetOperationExpression operationExpression=(JetOperationExpression)expression.getParent();
    if (operationExpression.getOperationReference() == expression) {
      showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.no.expression"));
      return;
    }
  }
  BindingContext bindingContext=AnalyzerFacade.analyzeFileWithCache((JetFile)expression.getContainingFile(),AnalyzerFacade.SINGLE_DECLARATION_PROVIDER);
  final JetType expressionType=bindingContext.get(BindingContext.EXPRESSION_TYPE,expression);
  if (expressionType instanceof NamespaceType) {
    showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.namespace.expression"));
    return;
  }
  if (expressionType != null && JetTypeChecker.INSTANCE.equalTypes(JetStandardLibrary.getJetStandardLibrary(project).getTuple0Type(),expressionType)) {
    showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.expression.has.unit.type"));
    return;
  }
  final PsiElement container=getContainer(expression);
  final PsiElement occurrenceContainer=getOccurrenceContainer(expression);
  if (container == null) {
    showErrorHint(project,editor,JetRefactoringBundle.message("cannot.refactor.no.container"));
    return;
  }
  final boolean isInplaceAvailableOnDataContext=editor.getSettings().isVariableInplaceRenameEnabled() && !ApplicationManager.getApplication().isUnitTestMode();
  final ArrayList<JetExpression> allOccurrences=findOccurrences(occurrenceContainer,expression);
  Pass<OccurrencesChooser.ReplaceChoice> callback=new Pass<OccurrencesChooser.ReplaceChoice>(){
    @Override public void pass(    OccurrencesChooser.ReplaceChoice replaceChoice){
      boolean replaceOccurrence=container != expression.getParent();
      final List<JetExpression> allReplaces;
      if (OccurrencesChooser.ReplaceChoice.ALL == replaceChoice) {
        if (allOccurrences.size() > 1)         replaceOccurrence=true;
        allReplaces=allOccurrences;
      }
 else {
        allReplaces=Collections.singletonList(expression);
      }
      PsiElement commonParent=PsiTreeUtil.findCommonParent(allReplaces);
      PsiElement commonContainer=getContainer(commonParent);
      JetNameValidatorImpl validator=new JetNameValidatorImpl(commonContainer,calculateAnchor(commonParent,commonContainer,allReplaces));
      String[] suggestedNames=JetNameSuggester.suggestNames(expression,validator);
      final LinkedHashSet<String> suggestedNamesSet=new LinkedHashSet<String>();
      Collections.addAll(suggestedNamesSet,suggestedNames);
      final Ref<JetProperty> propertyRef=new Ref<JetProperty>();
      final ArrayList<JetExpression> references=new ArrayList<JetExpression>();
      final Ref<JetExpression> reference=new Ref<JetExpression>();
      final Runnable introduceRunnable=introduceVariable(project,expression,suggestedNames,allReplaces,commonContainer,commonParent,replaceOccurrence,propertyRef,references,reference);
      final boolean finalReplaceOccurrence=replaceOccurrence;
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          ApplicationManager.getApplication().runWriteAction(introduceRunnable);
          JetProperty property=propertyRef.get();
          if (property != null) {
            editor.getCaretModel().moveToOffset(property.getTextOffset());
            editor.getSelectionModel().removeSelection();
            if (isInplaceAvailableOnDataContext) {
              PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
              PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(editor.getDocument());
              JetInplaceVariableIntroducer variableIntroducer=new JetInplaceVariableIntroducer(property,editor,project,INTRODUCE_VARIABLE,references.toArray(new JetExpression[references.size()]),reference.get(),finalReplaceOccurrence,property,false,false,expressionType);
              variableIntroducer.performInplaceRefactoring(suggestedNamesSet);
            }
          }
        }
      }
,INTRODUCE_VARIABLE,null);
    }
  }
;
  if (isInplaceAvailableOnDataContext) {
    OccurrencesChooser.<JetExpression>simpleChooser(editor).showChooser(expression,allOccurrences,callback);
  }
 else {
    callback.pass(OccurrencesChooser.ReplaceChoice.ALL);
  }
}
