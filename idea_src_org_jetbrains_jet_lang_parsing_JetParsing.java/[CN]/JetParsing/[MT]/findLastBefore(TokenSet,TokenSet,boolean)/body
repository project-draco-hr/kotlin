{
  PsiBuilder.Marker currentPosition=mark();
  int lastOccurrence=-1;
  int openAngleBrackets=0;
  int openBraces=0;
  int openParentheses=0;
  int openBrackets=0;
  IElementType previousToken=null;
  while (!eof()) {
    if (atSet(stopAt)) {
      if (openAngleBrackets == 0 && openBrackets == 0 && openBraces == 0 && openParentheses == 0 && (!dontStopRightAfterOccurrence || !lookFor.contains(previousToken)))       break;
    }
    if (at(LPAR)) {
      openParentheses++;
    }
 else     if (at(LT)) {
      openAngleBrackets++;
    }
 else     if (at(LBRACE)) {
      openBraces++;
    }
 else     if (at(LBRACKET)) {
      openBrackets++;
    }
 else     if (at(RPAR)) {
      openParentheses--;
    }
 else     if (at(GT)) {
      openAngleBrackets--;
    }
 else     if (at(RBRACE)) {
      openBraces--;
    }
 else     if (at(RBRACKET)) {
      openBrackets--;
    }
 else     if (atSet(lookFor) && openAngleBrackets == 0 && openBrackets == 0 && openBraces == 0 && openParentheses == 0) {
      lastOccurrence=myBuilder.getCurrentOffset();
    }
    previousToken=tt();
    advance();
  }
  currentPosition.rollbackTo();
  return lastOccurrence;
}
