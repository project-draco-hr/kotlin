{
  List<IntentionAction> availableActions=getAvailableActions();
  IntentionAction action=LightQuickFixTestCase.findActionWithText(availableActions,text);
  if (action == null) {
    if (actionShouldBeAvailable) {
      List<String> texts=getActionsTexts(availableActions);
      Collection<HighlightInfo> infos=doHighlighting();
      fail("Action with text '" + text + "' is not available in test "+ testFullPath+ "\n"+ "Available actions ("+ texts.size()+ "): "+ texts+ "\n"+ availableActions+ "\n"+ "Infos:"+ infos);
    }
 else {
      DirectiveBasedActionUtils.checkAvailableActionsAreExpected((JetFile)getFile(),availableActions);
    }
  }
 else {
    if (!actionShouldBeAvailable) {
      fail("Action '" + text + "' is available (but must not) in test "+ testFullPath);
    }
    ShowIntentionActionsHandler.chooseActionAndInvoke(getFile(),getEditor(),action,action.getText());
    UIUtil.dispatchAllInvocationEvents();
    if (!shouldBeAvailableAfterExecution()) {
      IntentionAction afterAction=LightQuickFixTestCase.findActionWithText(getAvailableActions(),text);
      if (afterAction != null) {
        fail("Action '" + text + "' is still available after its invocation in test "+ testFullPath);
      }
    }
    checkResultByFile(testFullPath.replace(".before.Main.",".after."));
    PsiFile mainFile=myFile;
    String extraFileNamePrefix=mainFile.getName().replace(".Main.kt",".data.Sample.");
    for (    PsiFile file : mainFile.getContainingDirectory().getFiles()) {
      if (!file.getName().startsWith(extraFileNamePrefix))       continue;
      myFile=file;
      String extraFileFullPath=testFullPath.replace(mainFile.getName(),file.getName());
      try {
        checkResultByFile(extraFileFullPath.replace(".before.",".after."));
      }
 catch (      AssertionError e) {
        if (e.getMessage().startsWith("Cannot find file")) {
          checkResultByFile(extraFileFullPath);
        }
 else         throw e;
      }
    }
  }
}
