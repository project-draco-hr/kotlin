{
  if (context.trace.get(BindingContext.PROCESSED,expression)) {
    return context.trace.getBindingContext().get(BindingContext.EXPRESSION_TYPE,expression);
  }
  JetType result;
  try {
    result=expression.accept(visitor,context);
    if (context.trace.get(BindingContext.PROCESSED,expression)) {
      return context.trace.getBindingContext().get(BindingContext.EXPRESSION_TYPE,expression);
    }
    if (result instanceof DeferredType) {
      result=((DeferredType)result).getActualType();
    }
    if (result != null) {
      context.trace.record(BindingContext.EXPRESSION_TYPE,expression,result);
    }
  }
 catch (  ReenteringLazyValueComputationException e) {
    context.trace.report(TYPECHECKER_HAS_RUN_INTO_RECURSIVE_PROBLEM.on(expression));
    result=null;
  }
  if (!context.trace.get(BindingContext.PROCESSED,expression)) {
    context.trace.record(BindingContext.RESOLUTION_SCOPE,expression,context.scope);
  }
  context.trace.record(BindingContext.PROCESSED,expression);
  return result;
}
