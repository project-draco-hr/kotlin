{
  ApplicationManager.setApplication(null,new Disposable(){
    @Override public void dispose(){
    }
  }
);
  File rootForAndroidDependencies=new File(pathManager.getDependenciesRoot());
  if (!rootForAndroidDependencies.exists()) {
    rootForAndroidDependencies.mkdirs();
  }
  SDKDownloader downloader=new SDKDownloader(pathManager);
  Emulator emulator=new Emulator(pathManager);
  AntRunner antRunner=new AntRunner(pathManager);
  downloader.downloadAll();
  downloader.unzipAll();
  PermissionManager.setPermissions(pathManager);
  antRunner.packLibraries();
  emulator.createEmulator();
  emulator.startEmulator();
  try {
    emulator.waitEmulatorStart();
    antRunner.cleanOutput();
    antRunner.compileSources();
    antRunner.installApplicationOnEmulator();
    return antRunner.runTestsOnEmulator();
  }
  finally {
    emulator.stopEmulator();
  }
}
