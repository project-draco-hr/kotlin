{
  try {
    List<TagData> tags=new ArrayList<TagData>();
    StringBuilder afterPreprocessing=preprocess(code.trim(),tags);
    VelocityContext context=new VelocityContext(MacroUtils.defaultVelocityContext());
    String renderedTemplate=VelocityUtils.getRenderedTemplate("template.velocity",context);
    StringBuilder result=new StringBuilder(renderedTemplate);
    result.append("<div class=\"code panel\" style=\"border-width: 1px;\">" + "<div class=\"codeContent panelContent\">" + "<div class=\"container\">");
    _JetLexer jetLexer=new _JetLexer(DUMMY_READER);
    jetLexer.reset(afterPreprocessing,0,afterPreprocessing.length(),_JetLexer.YYINITIAL);
    Iterator<TagData> iterator=tags.iterator();
    TagData tag=iterator.hasNext() ? iterator.next() : null;
    while (true) {
      int tokenEnd=jetLexer.getTokenEnd();
      while (tag != null && tag.end < tokenEnd) {
        result.append("<div class=\"jet hwarning\">Skipping a tag in the middle of a token: &lt;").append(tag.type).append("&gt;</div>");
        tag=iterator.hasNext() ? iterator.next() : null;
      }
      if (tag != null) {
        if (tag.start == tokenEnd) {
          tag.type.appendOpenTag(result,tag);
        }
      }
      if (tag != null) {
        if (tag.end == tokenEnd || (tag.nextToken && tag.start < tokenEnd)) {
          tag.type.appendCloseTag(result,tag);
          tag=iterator.hasNext() ? iterator.next() : null;
        }
      }
      IElementType token=jetLexer.advance();
      if (token == null)       break;
      String yytext=jetLexer.yytext().toString().replaceAll("\n","\r\n");
      String style=null;
      if (token instanceof JetKeywordToken) {
        style="keyword";
      }
 else       if (token == JetTokens.IDENTIFIER) {
        for (        IElementType softKeyword : JetTokens.SOFT_KEYWORDS.asSet()) {
          if (((JetKeywordToken)softKeyword).getValue().equals(yytext.toString())) {
            style="softkeyword";
            break;
          }
        }
        style=style == null ? "plain" : style;
      }
 else       if (styleMap.containsKey(token)) {
        style=styleMap.get(token);
      }
 else {
        style="plain";
      }
      result.append("<code class=\"jet ").append(style).append("\">");
      escapeHTML(result,yytext);
      result.append("</code>");
    }
    result.append("</div>");
    result.append("</div>");
    result.append("</div>");
    return result.toString();
  }
 catch (  Throwable e) {
    StringBuilder stringBuilder=new StringBuilder();
    stringBuilder.append("<div class=\"jet herror\">Jet highlighter error [").append(e.getClass().getSimpleName()).append("]: ");
    escapeHTML(stringBuilder,e.getMessage());
    stringBuilder.append("<br/>");
    stringBuilder.append("Original text:");
    stringBuilder.append("<pre>");
    escapeHTML(stringBuilder,code);
    stringBuilder.append("</pre>");
    stringBuilder.append("</div>");
    return stringBuilder.toString();
  }
}
