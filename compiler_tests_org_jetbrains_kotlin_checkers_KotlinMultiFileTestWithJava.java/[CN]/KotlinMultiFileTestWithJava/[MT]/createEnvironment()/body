{
  javaFilesDir=KotlinTestUtils.tmpDir("java-files");
  CompilerConfiguration configuration=KotlinTestUtils.compilerConfigurationForTests(getConfigurationKind(),getTestJdkKind(),CollectionsKt.plus(Collections.singletonList(KotlinTestUtils.getAnnotationsJar()),getExtraClasspath()),Collections.singletonList(javaFilesDir));
  configuration.add(CommonConfigurationKeys.SCRIPT_DEFINITIONS_KEY,StandardScriptDefinition.INSTANCE);
  if (isKotlinSourceRootNeeded()) {
    kotlinSourceRoot=KotlinTestUtils.tmpDir("kotlin-src");
    ContentRootsKt.addKotlinSourceRoot(configuration,kotlinSourceRoot.getPath());
  }
  return KotlinCoreEnvironment.createForTests(getTestRootDisposable(),configuration,getEnvironmentConfigFiles());
}
