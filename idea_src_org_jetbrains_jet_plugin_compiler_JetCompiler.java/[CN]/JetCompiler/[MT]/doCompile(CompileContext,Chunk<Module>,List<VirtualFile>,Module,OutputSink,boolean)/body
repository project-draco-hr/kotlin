{
  if (files.isEmpty())   return;
  MessageCollector messageCollector=new MessageCollectorAdapter(compileContext);
  CompilerEnvironment environment=CompilerUtils.getEnvironmentFor(compileContext,module,tests);
  if (!environment.success()) {
    environment.reportErrorsTo(messageCollector);
    return;
  }
  File scriptFile=tryToWriteScriptFile(compileContext,moduleChunk,files,module,tests,compileContext.getModuleOutputDirectory(module),environment.getOutput());
  if (scriptFile == null)   return;
  CompilerUtils.OutputItemsCollectorImpl collector=new CompilerUtils.OutputItemsCollectorImpl(environment.getOutput().getPath());
  runCompiler(messageCollector,environment,scriptFile,collector);
  outputSink.add(environment.getOutput().getPath(),collector.getOutputs(),collector.getSources().toArray(VirtualFile.EMPTY_ARRAY));
}
