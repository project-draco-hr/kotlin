{
  final Ref<String> result=Ref.create();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override @SuppressWarnings("unchecked") public void run(){
      JetFile file=(JetFile)sourcePosition.getFile();
      boolean isInLibrary=LibraryUtil.findLibraryEntry(file.getVirtualFile(),file.getProject()) != null;
      JetTypeMapper typeMapper=!isInLibrary ? prepareTypeMapper(file) : createTypeMapperForLibraryFile(sourcePosition.getElementAt(),file);
      result.set(getClassNameForElement(sourcePosition.getElementAt(),typeMapper,file,isInLibrary));
    }
  }
);
  return result.get();
}
