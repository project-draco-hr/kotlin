{
  final Ref<String> result=Ref.create();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override @SuppressWarnings("unchecked") public void run(){
      final JetFile namespace=(JetFile)sourcePosition.getFile();
      final JetTypeMapper typeMapper=prepareTypeMapper(namespace);
      PsiElement element=PsiTreeUtil.getParentOfType(sourcePosition.getElementAt(),JetClassOrObject.class,JetFunctionLiteralExpression.class,JetNamedFunction.class);
      if (element instanceof JetClassOrObject) {
        result.set(getJvmInternalNameForImpl(typeMapper,(JetClassOrObject)element));
      }
 else       if (element instanceof JetFunctionLiteralExpression) {
        result.set(typeMapper.getClosureAnnotator().classNameForAnonymousClass((JetFunctionLiteralExpression)element).getInternalName());
      }
 else       if (element instanceof JetNamedFunction) {
        PsiElement parent=PsiTreeUtil.getParentOfType(element,JetClassOrObject.class,JetFunctionLiteralExpression.class,JetNamedFunction.class);
        if (parent instanceof JetClassOrObject) {
          result.set(getJvmInternalNameForImpl(typeMapper,(JetClassOrObject)parent));
        }
 else         if (parent instanceof JetFunctionLiteralExpression || parent instanceof JetNamedFunction) {
          result.set(typeMapper.getClosureAnnotator().classNameForAnonymousClass((JetElement)element).getInternalName());
        }
      }
      if (result.isNull()) {
        FqName fqName=JetPsiUtil.getFQName(namespace);
        boolean multiFileNamespace=typeMapper.getClosureAnnotator().isMultiFileNamespace(fqName);
        String namespaceInternalName=NamespaceCodegen.getJVMClassNameForKotlinNs(fqName).getInternalName();
        if (multiFileNamespace) {
          String name=namespace.getName();
          result.set(namespaceInternalName + "$src$" + name.substring(0,name.lastIndexOf('.')));
        }
 else {
          result.set(namespaceInternalName);
        }
      }
    }
  }
);
  return result.get();
}
