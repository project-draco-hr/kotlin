{
  FqName fqName=file.getPackageFqName();
  CachedValue<JetTypeMapper> value=myTypeMappers.get(fqName);
  if (value == null) {
    value=CachedValuesManager.getManager(file.getProject()).createCachedValue(new CachedValueProvider<JetTypeMapper>(){
      @Override public Result<JetTypeMapper> compute(){
        AnalyzeExhaust analyzeExhaust=AnalyzerFacadeWithCache.analyzeFileWithCache(file);
        analyzeExhaust.throwIfError();
        Collection<JetFile> packageFiles=JetFilesProvider.getInstance(file.getProject()).allPackageFiles(file);
        DelegatingBindingTrace bindingTrace=new DelegatingBindingTrace(analyzeExhaust.getBindingContext(),"trace created in JetPositionManager");
        JetTypeMapper typeMapper=new JetTypeMapper(bindingTrace,ClassBuilderMode.FULL);
        CodegenBinding.initTrace(bindingTrace,packageFiles);
        return new Result<JetTypeMapper>(typeMapper,PsiModificationTracker.MODIFICATION_COUNT);
      }
    }
,false);
    myTypeMappers.put(fqName,value);
  }
  return value.getValue();
}
