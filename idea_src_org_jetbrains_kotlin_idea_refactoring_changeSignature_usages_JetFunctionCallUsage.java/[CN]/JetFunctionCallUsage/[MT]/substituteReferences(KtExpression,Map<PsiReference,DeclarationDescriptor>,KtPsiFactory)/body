{
  if (referenceMap.isEmpty() || resolvedCall == null)   return expression;
  KtExpression newExpression=(KtExpression)expression.copy();
  Map<KtSimpleNameExpression,KtSimpleNameExpression> nameCounterpartMap=ExtractorUtilKt.createNameCounterpartMap(expression,newExpression);
  Map<ValueParameterDescriptor,ResolvedValueArgument> valueArguments=resolvedCall.getValueArguments();
  List<Pair<KtElement,KtElement>> replacements=new ArrayList<Pair<KtElement,KtElement>>();
  for (  Map.Entry<PsiReference,DeclarationDescriptor> e : referenceMap.entrySet()) {
    DeclarationDescriptor descriptor=e.getValue();
    KtExpression argumentExpression;
    boolean addReceiver=false;
    if (descriptor instanceof ValueParameterDescriptor) {
      ValueParameterDescriptor parameterDescriptor=resolvedCall.getResultingDescriptor().getValueParameters().get(((ValueParameterDescriptor)descriptor).getIndex());
      ResolvedValueArgument resolvedValueArgument=valueArguments.get(parameterDescriptor);
      if (!(resolvedValueArgument instanceof ExpressionValueArgument))       continue;
      ValueArgument argument=((ExpressionValueArgument)resolvedValueArgument).getValueArgument();
      if (argument == null)       continue;
      argumentExpression=argument.getArgumentExpression();
    }
 else {
      addReceiver=!(descriptor instanceof ReceiverParameterDescriptor);
      argumentExpression=getReceiverExpressionIfMatched(resolvedCall.getExtensionReceiver(),descriptor,psiFactory);
      if (argumentExpression == null) {
        argumentExpression=getReceiverExpressionIfMatched(resolvedCall.getDispatchReceiver(),descriptor,psiFactory);
      }
    }
    if (argumentExpression == null)     continue;
    if (needSeparateVariable(argumentExpression) && PsiTreeUtil.getNonStrictParentOfType(getElement(),KtConstructorDelegationCall.class,KtDelegationSpecifier.class,KtParameter.class) == null) {
      final Ref<KtExpression> newExpressionRef=new Ref<KtExpression>();
      KotlinIntroduceVariableHandler.doRefactoring(getProject(),null,argumentExpression,Collections.singletonList(argumentExpression),new Function1<KtProperty,Unit>(){
        @Override public Unit invoke(        KtProperty property){
          newExpressionRef.set(psiFactory.createExpression(property.getName()));
          return null;
        }
      }
);
      argumentExpression=newExpressionRef.get();
    }
    KtExpression expressionToReplace=nameCounterpartMap.get(e.getKey().getElement());
    if (expressionToReplace == null)     continue;
    PsiElement parent=expressionToReplace.getParent();
    if (parent instanceof KtThisExpression) {
      expressionToReplace=(KtThisExpression)parent;
    }
    if (addReceiver) {
      KtCallExpression callExpression=PsiTreeUtil.getParentOfType(expressionToReplace,KtCallExpression.class,true);
      if (callExpression != null && PsiTreeUtil.isAncestor(callExpression.getCalleeExpression(),expressionToReplace,false)) {
        expressionToReplace=callExpression;
      }
 else {
        if (parent instanceof KtOperationExpression && ((KtOperationExpression)parent).getOperationReference() == expressionToReplace) {
          continue;
        }
      }
      replacements.add(new Pair<KtElement,KtElement>(expressionToReplace,psiFactory.createExpression(argumentExpression.getText() + "." + expressionToReplace.getText())));
    }
 else {
      replacements.add(new Pair<KtElement,KtElement>(expressionToReplace,argumentExpression));
    }
  }
  ContainerUtil.sort(replacements,REVERSED_TEXT_OFFSET_COMPARATOR);
  for (  Pair<KtElement,KtElement> replacement : replacements) {
    replacement.getFirst().replace(replacement.getSecond());
  }
  return newExpression;
}
