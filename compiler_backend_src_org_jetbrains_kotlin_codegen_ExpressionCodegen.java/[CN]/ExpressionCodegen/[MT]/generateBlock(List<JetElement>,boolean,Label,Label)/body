{
  final Label blockEnd=labelBlockEnd != null ? labelBlockEnd : new Label();
  final List<Function<StackValue,Void>> leaveTasks=Lists.newArrayList();
  StackValue answer=StackValue.none();
  for (Iterator<JetElement> iterator=statements.iterator(); iterator.hasNext(); ) {
    JetElement possiblyLabeledStatement=iterator.next();
    JetElement statement=possiblyLabeledStatement instanceof JetExpression ? JetPsiUtil.safeDeparenthesize((JetExpression)possiblyLabeledStatement,true) : possiblyLabeledStatement;
    if (statement instanceof JetNamedDeclaration) {
      JetNamedDeclaration declaration=(JetNamedDeclaration)statement;
      if (JetPsiUtil.isScriptDeclaration(declaration)) {
        continue;
      }
    }
    putDescriptorIntoFrameMap(statement);
    boolean isExpression=!iterator.hasNext() && !isStatement;
    if (isExpression && labelBeforeLastExpression != null) {
      v.mark(labelBeforeLastExpression);
    }
    StackValue result=isExpression ? gen(possiblyLabeledStatement) : genStatement(possiblyLabeledStatement);
    if (!iterator.hasNext()) {
      answer=result;
    }
 else {
      result.put(Type.VOID_TYPE,v);
    }
    addLeaveTaskToRemoveDescriptorFromFrameMap(statement,blockEnd,leaveTasks);
  }
  return new StackValueWithLeaveTask(answer,new ExtensionFunction0<StackValueWithLeaveTask,Unit>(){
    @Override public Unit invoke(    StackValueWithLeaveTask wrapper){
      if (labelBlockEnd == null) {
        v.mark(blockEnd);
      }
      for (      Function<StackValue,Void> task : Lists.reverse(leaveTasks)) {
        task.fun(wrapper.getStackValue());
      }
      return Unit.INSTANCE$;
    }
  }
);
}
