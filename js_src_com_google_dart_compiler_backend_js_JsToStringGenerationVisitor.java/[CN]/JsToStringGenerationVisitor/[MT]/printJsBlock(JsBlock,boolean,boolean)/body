{
  boolean needBraces=!x.isGlobalBlock();
  if (needBraces) {
    _blockOpen();
  }
  int count=0;
  for (Iterator<JsStatement> iter=x.getStatements().iterator(); iter.hasNext(); ++count) {
    boolean isGlobal=x.isGlobalBlock() || globalBlocks.contains(x);
    if (truncate && count > JSBLOCK_LINES_TO_PRINT) {
      p.print("[...]");
      _newlineOpt();
      break;
    }
    JsStatement stmt=iter.next();
    needSemi=true;
    boolean shouldRecordPositions=isGlobal && !(stmt instanceof JsBlock);
    boolean stmtIsGlobalBlock=false;
    if (isGlobal) {
      if (stmt instanceof JsBlock) {
        stmtIsGlobalBlock=true;
        globalBlocks.add((JsBlock)stmt);
      }
    }
    if (shouldRecordPositions) {
      statementStarts.add(p.getPosition());
    }
    accept(stmt);
    if (stmtIsGlobalBlock) {
      globalBlocks.remove(stmt);
    }
    if (needSemi) {
      boolean functionStmt=stmt instanceof JsExprStmt && ((JsExprStmt)stmt).getExpression() instanceof JsFunction;
      boolean lastStatement=!iter.hasNext() && needBraces && !JsRequiresSemiVisitor.exec(stmt);
      if (functionStmt) {
        if (lastStatement) {
          _newlineOpt();
        }
 else {
          _newline();
        }
      }
 else {
        if (lastStatement) {
          _semiOpt();
        }
 else {
          _semi();
        }
        _newlineOpt();
      }
    }
    if (shouldRecordPositions) {
      assert(statementStarts.size() == statementEnds.size() + 1);
      statementEnds.add(p.getPosition());
    }
  }
  if (needBraces) {
    p.indentOut();
    p.print('}');
    if (finalNewline) {
      _newlineOpt();
    }
  }
  needSemi=false;
}
