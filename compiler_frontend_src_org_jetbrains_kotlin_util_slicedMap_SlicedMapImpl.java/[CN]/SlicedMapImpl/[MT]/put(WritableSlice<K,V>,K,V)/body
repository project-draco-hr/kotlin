{
  if (!slice.check(key,value)) {
    return;
  }
  UserDataHolderImpl holder=map.get(key);
  if (holder == null) {
    holder=new UserDataHolderImpl();
    map.put(key,holder);
  }
  Key<V> sliceKey=slice.getKey();
  RewritePolicy rewritePolicy=slice.getRewritePolicy();
  if (rewritePolicy.rewriteProcessingNeeded(key)) {
    V oldValue=holder.getUserData(sliceKey);
    if (oldValue != null) {
      if (!rewritePolicy.processRewrite(slice,key,oldValue,value)) {
        return;
      }
    }
  }
  if (slice.isCollective()) {
    collectiveSliceKeys.put(slice,key);
  }
  int sliceKeyId=sliceKey.hashCode();
  if (!keyIdToSlice.contains(sliceKeyId)) {
    keyIdToSlice.put(sliceKeyId,slice);
  }
  holder.putUserData(sliceKey,value);
  slice.afterPut(this,key,value);
}
