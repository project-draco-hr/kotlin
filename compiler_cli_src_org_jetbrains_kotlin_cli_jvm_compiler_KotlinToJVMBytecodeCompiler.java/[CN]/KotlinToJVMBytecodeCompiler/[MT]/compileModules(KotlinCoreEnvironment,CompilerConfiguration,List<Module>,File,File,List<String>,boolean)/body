{
  Map<Module,ClassFileFactory> outputFiles=Maps.newHashMap();
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  ModuleVisibilityManager moduleVisibilityManager=ModuleVisibilityManager.SERVICE.getInstance(environment.getProject());
  for (  Module module : chunk) {
    moduleVisibilityManager.addModule(module);
  }
  for (  String path : friendPaths) {
    moduleVisibilityManager.addFriendPath(path);
  }
  String targetDescription="in targets [" + Joiner.on(", ").join(Collections2.transform(chunk,new Function<Module,String>(){
    @Override public String apply(    @Nullable Module input){
      return input != null ? input.getModuleName() + "-" + input.getModuleType() : "<null>";
    }
  }
)) + "] ";
  AnalysisResult result=analyze(environment,targetDescription);
  if (result == null) {
    return false;
  }
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  result.throwIfError();
  for (  Module module : chunk) {
    ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
    List<KtFile> jetFiles=CompileEnvironmentUtil.getJetFiles(environment.getProject(),getAbsolutePaths(directory,module),new Function1<String,Unit>(){
      @Override public Unit invoke(      String s){
        throw new IllegalStateException("Should have been checked before: " + s);
      }
    }
);
    File moduleOutputDirectory=new File(module.getOutputDirectory());
    GenerationState generationState=generate(environment,result,jetFiles,module,moduleOutputDirectory,module.getModuleName());
    outputFiles.put(module,generationState.getFactory());
  }
  for (  Module module : chunk) {
    ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
    writeOutput(configuration,outputFiles.get(module),new File(module.getOutputDirectory()),jarPath,jarRuntime,null);
  }
  return true;
}
