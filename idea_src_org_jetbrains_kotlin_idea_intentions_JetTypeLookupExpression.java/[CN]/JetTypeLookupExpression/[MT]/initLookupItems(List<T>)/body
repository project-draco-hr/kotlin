{
  LookupElement[] lookupElements=new LookupElement[lookupItems.size()];
  Iterator<T> iterator=lookupItems.iterator();
  for (int i=0; i < lookupElements.length; i++) {
    T suggestion=iterator.next();
    lookupElements[i]=LookupElementBuilder.create(suggestion,getLookupString(suggestion)).withInsertHandler(new InsertHandler<LookupElement>(){
      @Override public void handleInsert(      InsertionContext context,      LookupElement item){
        Editor topLevelEditor=InjectedLanguageUtil.getTopLevelEditor(context.getEditor());
        TemplateState templateState=TemplateManagerImpl.getTemplateState(topLevelEditor);
        if (templateState != null) {
          TextRange range=templateState.getCurrentVariableRange();
          if (range != null) {
            topLevelEditor.getDocument().replaceString(range.getStartOffset(),range.getEndOffset(),getResult((T)item.getObject()));
          }
        }
      }
    }
);
  }
  return lookupElements;
}
