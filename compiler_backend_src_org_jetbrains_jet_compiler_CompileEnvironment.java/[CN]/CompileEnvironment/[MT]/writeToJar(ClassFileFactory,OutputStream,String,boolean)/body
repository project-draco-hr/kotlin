{
  try {
    Manifest manifest=new Manifest();
    final Attributes mainAttributes=manifest.getMainAttributes();
    mainAttributes.putValue("Manifest-Version","1.0");
    mainAttributes.putValue("Created-By","JetBrains Kotlin");
    if (mainClass != null) {
      mainAttributes.putValue("Main-Class",mainClass);
    }
    JarOutputStream stream=new JarOutputStream(fos,manifest);
    List<String> sanitized=Arrays.asList("kotlin/","std/");
    try {
      for (      String file : factory.files()) {
        boolean skip=false;
        for (        String prefix : sanitized) {
          if (file.startsWith(prefix)) {
            skip=true;
            break;
          }
        }
        if (!skip) {
          stream.putNextEntry(new JarEntry(file));
          stream.write(factory.asBytes(file));
        }
      }
      if (includeRuntime) {
        writeRuntimeToJar(stream);
      }
    }
  finally {
      stream.close();
      fos.close();
    }
  }
 catch (  IOException e) {
    throw new CompileEnvironmentException("Failed to generate jar file",e);
  }
}
