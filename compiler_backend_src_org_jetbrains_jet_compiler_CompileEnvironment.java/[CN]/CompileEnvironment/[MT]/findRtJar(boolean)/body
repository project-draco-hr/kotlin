{
  String javaHome=System.getenv("JAVA_HOME");
  if (javaHome == null) {
    javaHome=System.getProperty("java.home");
    if ("jre".equals(new File(javaHome).getName())) {
      javaHome=new File(javaHome).getParent();
    }
  }
  File rtJar;
  if (javaHome == null) {
    rtJar=findActiveRtJar(failOnError);
    if (rtJar == null && failOnError) {
      throw new CompileEnvironmentException("JAVA_HOME environment variable needs to be defined");
    }
  }
 else {
    rtJar=findRtJar(javaHome);
  }
  if ((rtJar == null || !rtJar.exists()) && failOnError) {
    rtJar=findActiveRtJar(failOnError);
    if ((rtJar == null || !rtJar.exists())) {
      throw new CompileEnvironmentException("No rt.jar found under JAVA_HOME=" + javaHome);
    }
  }
  return rtJar;
}
