{
  List<AnalyzerScriptParameter> scriptParameters=environment.getConfiguration().getList(JVMConfigurationKeys.SCRIPT_PARAMETERS);
  if (!scriptParameters.isEmpty()) {
    JetScriptDefinitionProvider.getInstance(environment.getProject()).addScriptDefinition(new JetScriptDefinition(".kts",scriptParameters));
  }
  GenerationState state=analyzeAndGenerate(environment);
  if (state == null) {
    return null;
  }
  GeneratedClassLoader classLoader;
  try {
    classLoader=new GeneratedClassLoader(state.getFactory(),new URLClassLoader(new URL[]{paths.getRuntimePath().toURI().toURL()},AllModules.class.getClassLoader()));
    FqName nameForScript=ScriptNameUtil.classNameForScript(environment.getSourceFiles().get(0).getScript());
    return classLoader.loadClass(nameForScript.asString());
  }
 catch (  Exception e) {
    throw new RuntimeException("Failed to evaluate script: " + e,e);
  }
}
