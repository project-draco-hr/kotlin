{
  FqName mainClass=findMainClass(configuration.getEnvironment().getSourceFiles());
  GenerationState generationState=analyzeAndGenerate(configuration);
  if (generationState == null) {
    return false;
  }
  try {
    ClassFileFactory factory=generationState.getFactory();
    if (jar != null) {
      FileOutputStream os=null;
      try {
        os=new FileOutputStream(jar);
        CompileEnvironmentUtil.writeToJar(factory,new FileOutputStream(jar),mainClass,includeRuntime);
        os.close();
      }
 catch (      FileNotFoundException e) {
        throw new CompileEnvironmentException("Invalid jar path " + jar,e);
      }
catch (      IOException e) {
        throw ExceptionUtils.rethrow(e);
      }
 finally {
        try {
          os.close();
        }
 catch (        Throwable e) {
        }
      }
    }
 else     if (outputDir != null) {
      CompileEnvironmentUtil.writeToOutputDirectory(factory,outputDir);
    }
 else {
      throw new CompileEnvironmentException("Output directory or jar file is not specified - no files will be saved to the disk");
    }
    return true;
  }
  finally {
    generationState.destroy();
  }
}
