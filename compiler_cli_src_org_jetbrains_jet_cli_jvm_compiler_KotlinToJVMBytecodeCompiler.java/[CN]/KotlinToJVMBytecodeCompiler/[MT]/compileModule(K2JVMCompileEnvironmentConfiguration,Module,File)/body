{
  if (moduleBuilder.getSourceFiles().isEmpty()) {
    throw new CompileEnvironmentException("No source files where defined");
  }
  CompilerConfiguration compilerConfiguration=configuration.getEnvironment().getConfiguration().copy();
  for (  String sourceFile : moduleBuilder.getSourceFiles()) {
    File source=new File(sourceFile);
    if (!source.isAbsolute()) {
      source=new File(directory,sourceFile);
    }
    if (!source.exists()) {
      throw new CompileEnvironmentException("'" + source + "' does not exist");
    }
    compilerConfiguration.add(CommonConfigurationKeys.SOURCE_ROOTS_KEY,source.getPath());
  }
  for (  String classpathRoot : moduleBuilder.getClasspathRoots()) {
    compilerConfiguration.add(JVMConfigurationKeys.CLASSPATH_KEY,new File(classpathRoot));
  }
  for (  String annotationsRoot : moduleBuilder.getAnnotationsRoots()) {
    compilerConfiguration.add(JVMConfigurationKeys.ANNOTATIONS_PATH_KEY,new File(annotationsRoot));
  }
  Disposable parentDisposable=new Disposable(){
    @Override public void dispose(){
    }
  }
;
  JetCoreEnvironment environment=null;
  try {
    environment=JetCoreEnvironment.createCoreEnvironmentForJVM(parentDisposable,compilerConfiguration);
    K2JVMCompileEnvironmentConfiguration currentK2JVMConfiguration=new K2JVMCompileEnvironmentConfiguration(environment);
    GenerationState generationState=analyzeAndGenerate(currentK2JVMConfiguration);
    if (generationState == null) {
      return null;
    }
    return generationState.getFactory();
  }
  finally {
    if (environment != null) {
      Disposer.dispose(parentDisposable);
    }
  }
}
