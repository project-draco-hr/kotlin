{
  if (moduleBuilder.getSourceFiles().isEmpty()) {
    throw new CompileEnvironmentException("No source files where defined");
  }
  CompileEnvironmentUtil.addSourcesFromModuleToEnvironment(configuration.getEnvironment(),moduleBuilder,directory);
  for (  String classpathRoot : moduleBuilder.getClasspathRoots()) {
    configuration.getEnvironment().addToClasspath(new File(classpathRoot));
  }
  for (  String annotationsRoot : moduleBuilder.getAnnotationsRoots()) {
    JetCoreEnvironment.addExternalAnnotationsRoot(PathUtil.jarFileOrDirectoryToVirtualFile(new File(annotationsRoot)));
  }
  GenerationState generationState=analyzeAndGenerate(configuration);
  if (generationState == null) {
    return null;
  }
  return generationState.getFactory();
}
