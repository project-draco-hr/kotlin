{
  File dirFile=new File(directory);
  final List<String> javaFilePaths=new ArrayList<String>();
  final List<String> ktFilePaths=new ArrayList<String>();
  FileUtil.processFilesRecursively(dirFile,new Processor<File>(){
    @Override public boolean process(    File file){
      if (file.getName().endsWith(".kt")) {
        ktFilePaths.add(relativePath(file));
      }
 else       if (file.getName().endsWith(".java")) {
        javaFilePaths.add(file.getPath());
      }
      return true;
    }
  }
);
  CompilerConfiguration configuration=KotlinTestUtils.compilerConfigurationForTests(ConfigurationKind.ALL,TestJdkKind.MOCK_JDK,KotlinTestUtils.getAnnotationsJar());
  JvmContentRootsKt.addJavaSourceRoot(configuration,dirFile);
  myEnvironment=KotlinCoreEnvironment.createForTests(getTestRootDisposable(),configuration,EnvironmentConfigFiles.JVM_CONFIG_FILES);
  loadFiles(ArrayUtil.toStringArray(ktFilePaths));
  classFileFactory=GenerationUtils.compileManyFilesGetGenerationStateForTest(myEnvironment.getProject(),myFiles.getPsiFiles(),new JvmPackagePartProvider(myEnvironment)).getFactory();
  File kotlinOut=KotlinTestUtils.tmpDir(toString());
  OutputUtilsKt.writeAllTo(classFileFactory,kotlinOut);
  List<String> javacOptions=new ArrayList<String>(0);
  for (  KtFile jetFile : myFiles.getPsiFiles()) {
    javacOptions.addAll(InTextDirectivesUtils.findListWithPrefixes(jetFile.getText(),"// JAVAC_OPTIONS:"));
  }
  File javaOut=compileJava(javaFilePaths,Collections.singletonList(kotlinOut.getPath()),javacOptions);
  JvmContentRootsKt.addJvmClasspathRoot(configuration,javaOut);
  blackBox();
}
