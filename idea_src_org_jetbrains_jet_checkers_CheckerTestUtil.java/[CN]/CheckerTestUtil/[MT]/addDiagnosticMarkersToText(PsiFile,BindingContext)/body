{
  Collection<Diagnostic> diagnostics=bindingContext.getDiagnostics();
  StringBuffer result=new StringBuffer();
  String text=psiFile.getText();
  if (!diagnostics.isEmpty()) {
    List<DiagnosticDescriptor> diagnosticDescriptors=getSortedDiagnosticDescriptors(diagnostics);
    Stack<DiagnosticDescriptor> opened=new Stack<DiagnosticDescriptor>();
    ListIterator<DiagnosticDescriptor> iterator=diagnosticDescriptors.listIterator();
    DiagnosticDescriptor currentDescriptor=iterator.next();
    for (int i=0; i < text.length(); i++) {
      char c=text.charAt(i);
      while (!opened.isEmpty() && i == opened.peek().end) {
        closeDiagnosticString(result);
        opened.pop();
      }
      if (currentDescriptor != null && i == currentDescriptor.start) {
        openDiagnosticsString(result,currentDescriptor);
        opened.push(currentDescriptor);
        if (iterator.hasNext()) {
          currentDescriptor=iterator.next();
        }
 else {
          currentDescriptor=null;
        }
      }
      result.append(c);
    }
  }
 else {
    result.append(text);
  }
  return result;
}
