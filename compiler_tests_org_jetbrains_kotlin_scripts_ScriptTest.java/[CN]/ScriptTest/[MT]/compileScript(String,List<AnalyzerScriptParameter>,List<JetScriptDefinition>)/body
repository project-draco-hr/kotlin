{
  KotlinPaths paths=PathUtil.getKotlinPathsForDistDirectory();
  MessageCollector messageCollector=PrintingMessageCollector.PLAIN_TEXT_TO_SYSTEM_ERR;
  Disposable rootDisposable=Disposer.newDisposable();
  try {
    CompilerConfiguration configuration=JetTestUtils.compilerConfigurationForTests(ConfigurationKind.JDK_AND_ANNOTATIONS,TestJdkKind.FULL_JDK);
    configuration.put(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY,messageCollector);
    addKotlinSourceRoot(configuration,"compiler/testData/script/" + scriptPath);
    configuration.addAll(CommonConfigurationKeys.SCRIPT_DEFINITIONS_KEY,scriptDefinitions);
    configuration.put(JVMConfigurationKeys.SCRIPT_PARAMETERS,scriptParameters);
    KotlinCoreEnvironment environment=KotlinCoreEnvironment.createForProduction(rootDisposable,configuration,EnvironmentConfigFiles.JVM_CONFIG_FILES);
    try {
      JetScriptDefinitionProvider.getInstance(environment.getProject()).markFileAsScript(environment.getSourceFiles().get(0));
      return KotlinToJVMBytecodeCompiler.compileScript(configuration,paths,environment);
    }
 catch (    CompilationException e) {
      messageCollector.report(CompilerMessageSeverity.EXCEPTION,OutputMessageUtil.renderException(e),MessageUtil.psiElementToMessageLocation(e.getElement()));
      return null;
    }
catch (    Throwable t) {
      MessageCollectorUtil.reportException(messageCollector,t);
      return null;
    }
  }
  finally {
    Disposer.dispose(rootDisposable);
  }
}
