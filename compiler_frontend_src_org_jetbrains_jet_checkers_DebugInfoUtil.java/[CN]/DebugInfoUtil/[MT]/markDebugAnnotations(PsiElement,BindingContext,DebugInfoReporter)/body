{
  final Map<JetReferenceExpression,DiagnosticFactory> markedWithErrorElements=Maps.newHashMap();
  for (  Diagnostic diagnostic : bindingContext.getDiagnostics()) {
    DiagnosticFactory factory=diagnostic.getFactory();
    if (Errors.UNRESOLVED_REFERENCE_DIAGNOSTICS.contains(diagnostic.getFactory())) {
      markedWithErrorElements.put((JetReferenceExpression)diagnostic.getPsiElement(),factory);
    }
 else     if (factory == Errors.SUPER_IS_NOT_AN_EXPRESSION || factory == Errors.SUPER_NOT_AVAILABLE) {
      JetSuperExpression superExpression=(JetSuperExpression)diagnostic.getPsiElement();
      markedWithErrorElements.put(superExpression.getInstanceReference(),factory);
    }
 else     if (factory == Errors.EXPRESSION_EXPECTED_PACKAGE_FOUND) {
      markedWithErrorElements.put((JetSimpleNameExpression)diagnostic.getPsiElement(),factory);
    }
 else     if (factory == Errors.UNSUPPORTED) {
      for (      JetReferenceExpression reference : PsiTreeUtil.findChildrenOfType(diagnostic.getPsiElement(),JetReferenceExpression.class)) {
        markedWithErrorElements.put(reference,factory);
      }
    }
  }
  root.acceptChildren(new JetTreeVisitorVoid(){
    @Override public void visitReferenceExpression(    @NotNull JetReferenceExpression expression){
      super.visitReferenceExpression(expression);
      if (!BindingContextUtils.isExpressionWithValidReference(expression,bindingContext)) {
        return;
      }
      if (expression instanceof JetSimpleNameExpression) {
        JetSimpleNameExpression nameExpression=(JetSimpleNameExpression)expression;
        IElementType elementType=expression.getNode().getElementType();
        if (elementType == JetNodeTypes.OPERATION_REFERENCE) {
          IElementType referencedNameElementType=nameExpression.getReferencedNameElementType();
          if (EXCLUDED.contains(referencedNameElementType)) {
            return;
          }
          if (JetTokens.LABELS.contains(referencedNameElementType))           return;
        }
 else         if (nameExpression.getReferencedNameElementType() == JetTokens.THIS_KEYWORD) {
          return;
        }
      }
      String target=null;
      DeclarationDescriptor declarationDescriptor=bindingContext.get(REFERENCE_TARGET,expression);
      if (declarationDescriptor != null) {
        target=declarationDescriptor.toString();
      }
      if (target == null) {
        PsiElement labelTarget=bindingContext.get(LABEL_TARGET,expression);
        if (labelTarget != null) {
          target=labelTarget.getText();
        }
      }
      if (target == null) {
        Collection<? extends DeclarationDescriptor> declarationDescriptors=bindingContext.get(AMBIGUOUS_REFERENCE_TARGET,expression);
        if (declarationDescriptors != null) {
          target="[" + declarationDescriptors.size() + " descriptors]";
        }
      }
      if (target == null) {
        Collection<? extends PsiElement> labelTargets=bindingContext.get(AMBIGUOUS_LABEL_TARGET,expression);
        if (labelTargets != null) {
          target="[" + labelTargets.size() + " elements]";
        }
      }
      boolean resolved=target != null;
      boolean markedWithError=markedWithErrorElements.containsKey(expression);
      if (expression instanceof JetArrayAccessExpression && markedWithErrorElements.containsKey(((JetArrayAccessExpression)expression).getArrayExpression())) {
        markedWithError=true;
      }
      JetType expressionType=bindingContext.get(EXPRESSION_TYPE,expression);
      DiagnosticFactory factory=markedWithErrorElements.get(expression);
      if (declarationDescriptor != null && (ErrorUtils.isError(declarationDescriptor) || ErrorUtils.containsErrorType(expressionType))) {
        if (factory != Errors.EXPRESSION_EXPECTED_PACKAGE_FOUND) {
          debugInfoReporter.reportElementWithErrorType(expression);
        }
      }
      if (resolved && markedWithError) {
        if (Errors.UNRESOLVED_REFERENCE_DIAGNOSTICS.contains(factory)) {
          debugInfoReporter.reportUnresolvedWithTarget(expression,target);
        }
      }
 else       if (!resolved && !markedWithError) {
        debugInfoReporter.reportMissingUnresolved(expression);
      }
    }
  }
);
}
