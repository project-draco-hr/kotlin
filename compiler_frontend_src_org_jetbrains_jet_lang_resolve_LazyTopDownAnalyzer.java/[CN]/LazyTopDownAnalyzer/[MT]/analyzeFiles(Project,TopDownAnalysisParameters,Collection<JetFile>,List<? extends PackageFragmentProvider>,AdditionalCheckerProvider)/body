{
  TopDownAnalysisContext c=new TopDownAnalysisContext(topDownAnalysisParameters);
  ResolveSession resolveSession=new InjectorForLazyResolve(project,new GlobalContextImpl((LockBasedStorageManager)c.getStorageManager(),c.getExceptionTracker()),(ModuleDescriptorImpl)moduleDescriptor,new FileBasedDeclarationProviderFactory(c.getStorageManager(),files),trace,additionalCheckerProvider).getResolveSession();
  CompositePackageFragmentProvider provider=new CompositePackageFragmentProvider(KotlinPackage.plus(Arrays.asList(resolveSession.getPackageFragmentProvider()),additionalProviders));
  ((ModuleDescriptorImpl)moduleDescriptor).initialize(provider);
  setKotlinCodeAnalyzer(resolveSession);
  analyzeDeclarations(c.getTopDownAnalysisParameters(),files);
  return c;
}
