{
  CompilerConfiguration configuration=new CompilerConfiguration();
  addJavaSourceRoots(configuration,javaSource);
  if (jdkKind == TestJdkKind.MOCK_JDK) {
    addJvmClasspathRoot(configuration,findMockJdkRtJar());
  }
 else   if (jdkKind == TestJdkKind.ANDROID_API) {
    addJvmClasspathRoot(configuration,findAndroidApiJar());
  }
 else {
    addJvmClasspathRoots(configuration,PathUtil.getJdkClassesRoots());
  }
  if (configurationKind == ALL) {
    addJvmClasspathRoot(configuration,ForTestCompileRuntime.runtimeJarForTests());
    addJvmClasspathRoot(configuration,ForTestCompileRuntime.reflectJarForTests());
  }
  addJvmClasspathRoots(configuration,classpath);
  if (configurationKind == ALL || configurationKind == JDK_AND_ANNOTATIONS) {
    if (jdkKind == TestJdkKind.ANDROID_API) {
      configuration.add(ANNOTATIONS_PATH_KEY,getAndroidSdkAnnotationsJar());
    }
 else {
      configuration.add(ANNOTATIONS_PATH_KEY,getJdkAnnotationsJar());
    }
  }
  return configuration;
}
