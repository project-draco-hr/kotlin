{
  File rootForAndroidDependencies=new File(pathManager.getDependenciesRoot());
  if (!rootForAndroidDependencies.exists()) {
    rootForAndroidDependencies.mkdirs();
  }
  SDKDownloader downloader=new SDKDownloader(pathManager);
  Emulator emulator=new Emulator(pathManager,Emulator.X86);
  AntRunner antRunner=new AntRunner(pathManager);
  downloader.downloadAll();
  downloader.unzipAll();
  String platformPrefixProperty=System.setProperty(PlatformUtils.PLATFORM_PREFIX_KEY,"Idea");
  try {
    PermissionManager.setPermissions(pathManager);
    antRunner.packLibraries();
    emulator.createEmulator();
    emulator.startEmulator();
    try {
      emulator.waitEmulatorStart();
      antRunner.cleanOutput();
      antRunner.compileSources();
      antRunner.installApplicationOnEmulator();
      return antRunner.runTestsOnEmulator();
    }
 catch (    RuntimeException e) {
      e.printStackTrace();
      throw e;
    }
 finally {
      emulator.stopEmulator();
    }
  }
 catch (  RuntimeException e) {
    e.printStackTrace();
    throw e;
  }
 finally {
    if (platformPrefixProperty != null) {
      System.setProperty(PlatformUtils.PLATFORM_PREFIX_KEY,platformPrefixProperty);
    }
 else {
      System.clearProperty(PlatformUtils.PLATFORM_PREFIX_KEY);
    }
    emulator.finishEmulatorProcesses();
  }
}
