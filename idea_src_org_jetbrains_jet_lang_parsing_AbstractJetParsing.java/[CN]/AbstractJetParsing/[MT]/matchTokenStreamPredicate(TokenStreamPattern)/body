{
  PsiBuilder.Marker currentPosition=mark();
  int openAngleBrackets=0;
  int openBraces=0;
  int openParentheses=0;
  int openBrackets=0;
  while (!eof()) {
    if (pattern.processToken(myBuilder.getCurrentOffset(),pattern.isTopLevel(openAngleBrackets,openBrackets,openBraces,openParentheses))) {
      break;
    }
    if (at(LPAR)) {
      openParentheses++;
    }
 else     if (at(LT)) {
      openAngleBrackets++;
    }
 else     if (at(LBRACE)) {
      openBraces++;
    }
 else     if (at(LBRACKET)) {
      openBrackets++;
    }
 else     if (at(RPAR)) {
      openParentheses--;
    }
 else     if (at(GT)) {
      openAngleBrackets--;
    }
 else     if (at(RBRACE)) {
      openBraces--;
    }
 else     if (at(RBRACKET)) {
      openBrackets--;
    }
    advance();
  }
  currentPosition.rollbackTo();
  return pattern.result();
}
