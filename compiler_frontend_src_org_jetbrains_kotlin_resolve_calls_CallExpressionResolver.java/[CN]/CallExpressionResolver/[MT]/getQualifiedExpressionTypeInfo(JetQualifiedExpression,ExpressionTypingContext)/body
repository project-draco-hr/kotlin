{
  JetExpression selectorExpression=expression.getSelectorExpression();
  JetExpression receiverExpression=expression.getReceiverExpression();
  boolean safeCall=(expression.getOperationSign() == JetTokens.SAFE_ACCESS);
  ResolutionContext contextForReceiver=context.replaceExpectedType(NO_EXPECTED_TYPE).replaceContextDependency(INDEPENDENT).replaceInsideCallChain(true);
  JetTypeInfo receiverTypeInfo=expressionTypingServices.getTypeInfo(receiverExpression,contextForReceiver);
  JetType receiverType=receiverTypeInfo.getType();
  QualifierReceiver qualifierReceiver=(QualifierReceiver)context.trace.get(BindingContext.QUALIFIER,receiverExpression);
  if (receiverType == null)   receiverType=ErrorUtils.createErrorType("Type for " + expression.getText());
  ReceiverValue receiver=qualifierReceiver == null ? new ExpressionReceiver(receiverExpression,receiverType) : qualifierReceiver;
  DataFlowInfo receiverDataFlowInfo=receiverTypeInfo.getDataFlowInfo();
  context=context.replaceDataFlowInfo(receiverDataFlowInfo);
  JetTypeInfo selectorReturnTypeInfo=getSelectorReturnTypeInfo(receiver,expression.getOperationTokenNode(),selectorExpression,context);
  JetType selectorReturnType=selectorReturnTypeInfo.getType();
  resolveDeferredReceiverInQualifiedExpression(qualifierReceiver,expression,context);
  checkNestedClassAccess(expression,context);
  if (safeCall) {
    if (selectorReturnType != null) {
      if (TypeUtils.isNullableType(receiverType)) {
        selectorReturnType=TypeUtils.makeNullable(selectorReturnType);
        selectorReturnTypeInfo=selectorReturnTypeInfo.replaceType(selectorReturnType);
      }
    }
  }
  if (selectorExpression != null && selectorReturnType != null) {
    context.trace.recordType(selectorExpression,selectorReturnType);
  }
  CompileTimeConstant<?> value=constantExpressionEvaluator.evaluateExpression(expression,context.trace,context.expectedType);
  if (value != null && value.isPure()) {
    return dataFlowAnalyzer.createCompileTimeConstantTypeInfo(value,expression,context);
  }
  JetTypeInfo typeInfo;
  DataFlowInfo safeCallChainInfo;
  if (receiverTypeInfo instanceof JetTypeInfoInsideSafeCall) {
    safeCallChainInfo=((JetTypeInfoInsideSafeCall)receiverTypeInfo).getSafeCallChainInfo();
  }
 else {
    safeCallChainInfo=null;
  }
  if (safeCall) {
    if (safeCallChainInfo == null)     safeCallChainInfo=receiverDataFlowInfo;
    if (context.insideCallChain) {
      typeInfo=new JetTypeInfoInsideSafeCall(selectorReturnTypeInfo,safeCallChainInfo);
    }
 else {
      typeInfo=selectorReturnTypeInfo.replaceDataFlowInfo(safeCallChainInfo);
    }
  }
 else {
    if (context.insideCallChain || safeCallChainInfo == null) {
      typeInfo=new JetTypeInfoInsideSafeCall(selectorReturnTypeInfo,selectorReturnTypeInfo.getDataFlowInfo());
    }
 else {
      typeInfo=selectorReturnTypeInfo.replaceDataFlowInfo(safeCallChainInfo);
    }
  }
  if (context.contextDependency == INDEPENDENT) {
    dataFlowAnalyzer.checkType(typeInfo.getType(),expression,context);
  }
  return typeInfo;
}
