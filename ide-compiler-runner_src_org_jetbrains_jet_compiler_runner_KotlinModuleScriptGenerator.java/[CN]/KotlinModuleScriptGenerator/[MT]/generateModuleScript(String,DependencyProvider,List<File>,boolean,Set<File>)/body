{
  final StringBuilder script=new StringBuilder();
  if (tests) {
    script.append("// Module script for tests\n");
  }
 else {
    script.append("// Module script for production\n");
  }
  script.append("import kotlin.modules.*\n");
  script.append("fun project() {\n");
  script.append("    module(\"" + moduleName + "\") {\n");
  for (  File sourceFile : sourceFiles) {
    script.append("        sources += \"" + toSystemIndependentName(sourceFile.getPath()) + "\"\n");
  }
  dependencyProvider.processClassPath(new DependencyProcessor(){
    @Override public void processClassPathSection(    @NotNull String sectionDescription,    @NotNull Collection<File> files){
      script.append("        // " + sectionDescription + "\n");
      for (      File file : files) {
        if (directoriesToFilterOut.contains(file)) {
          script.append("        // Output directory, commented out\n");
          script.append("        // ");
        }
        script.append("        classpath += \"" + toSystemIndependentName(file.getPath()) + "\"\n");
      }
    }
    @Override public void processAnnotationRoots(    @NotNull List<File> files){
      script.append("        // External annotations\n");
      for (      File file : files) {
        script.append("        annotationsPath += \"").append(toSystemIndependentName(file.getPath())).append("\"\n");
      }
    }
  }
);
  script.append("    }\n");
  script.append("}\n");
  return script;
}
