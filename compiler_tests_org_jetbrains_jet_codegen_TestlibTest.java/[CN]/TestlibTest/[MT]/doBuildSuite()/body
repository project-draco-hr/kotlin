{
  try {
    CompileSession session=new CompileSession(myEnvironment,MessageRenderer.PLAIN,System.err,false);
    myEnvironment.addToClasspath(ForTestCompileStdlib.stdlibJarForTests());
    File junitJar=new File("libraries/lib/junit-4.9.jar");
    if (!junitJar.exists()) {
      throw new AssertionError();
    }
    myEnvironment.addToClasspath(junitJar);
    CoreLocalFileSystem localFileSystem=myEnvironment.getLocalFileSystem();
    session.addSources(localFileSystem.findFileByPath(JetParsingTest.getTestDataDir() + "/../../libraries/stdlib/test"));
    session.addSources(localFileSystem.findFileByPath(JetParsingTest.getTestDataDir() + "/../../libraries/kunit/src"));
    if (!session.analyze()) {
      throw new RuntimeException("There were compilation errors");
    }
    ClassFileFactory classFileFactory=session.generate(false);
    final GeneratedClassLoader loader=new GeneratedClassLoader(classFileFactory,new URLClassLoader(new URL[]{ForTestCompileStdlib.stdlibJarForTests().toURI().toURL(),junitJar.toURI().toURL()},TestCase.class.getClassLoader()));
    ClosureAnnotator closureAnnotator=new ClosureAnnotator(session.getMyBindingContext(),session.getSourceFileNamespaces());
    JetTypeMapper typeMapper=new JetTypeMapper(classFileFactory.state.getStandardLibrary(),session.getMyBindingContext(),closureAnnotator);
    TestSuite suite=new TestSuite("stdlib_test");
    try {
      for (      JetFile jetFile : session.getSourceFileNamespaces()) {
        for (        JetDeclaration decl : jetFile.getDeclarations()) {
          if (decl instanceof JetClass) {
            JetClass jetClass=(JetClass)decl;
            ClassDescriptor descriptor=(ClassDescriptor)session.getMyBindingContext().get(BindingContext.DECLARATION_TO_DESCRIPTOR,jetClass);
            Set<JetType> allSuperTypes=new THashSet<JetType>();
            CodegenUtil.addSuperTypes(descriptor.getDefaultType(),allSuperTypes);
            for (            JetType type : allSuperTypes) {
              String internalName=typeMapper.mapType(type).getInternalName();
              if (internalName.equals("junit/framework/Test")) {
                String name=typeMapper.mapType(descriptor.getDefaultType()).getInternalName();
                System.out.println(name);
                Class<TestCase> aClass=(Class<TestCase>)loader.loadClass(name.replace('/','.'));
                if ((aClass.getModifiers() & Modifier.ABSTRACT) == 0 && (aClass.getModifiers() & Modifier.PUBLIC) != 0) {
                  try {
                    Constructor<TestCase> constructor=aClass.getConstructor();
                    if (constructor != null && (constructor.getModifiers() & Modifier.PUBLIC) != 0) {
                      suite.addTestSuite(aClass);
                    }
                  }
 catch (                  NoSuchMethodException e) {
                  }
                }
                break;
              }
            }
          }
        }
      }
    }
  finally {
      typeMapper=null;
    }
    return suite;
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new RuntimeException(e);
  }
}
