{
  if (expectedReturnType == FORBIDDEN) {
    trace.getErrorHandler().genericError(expression.getNode(),"'return' is not allowed here");
    return;
  }
  JetExpression returnedExpression=expression.getReturnedExpression();
  JetType returnedType=JetStandardClasses.getUnitType();
  if (returnedExpression != null) {
    returnedType=getType(scope,returnedExpression,false);
  }
 else {
    if (expectedReturnType != null && !JetStandardClasses.isUnit(expectedReturnType)) {
      trace.getErrorHandler().genericError(expression.getNode(),"This function must return a value of type " + expectedReturnType);
    }
  }
  if (expectedReturnType != null && returnedType != null) {
    if (!semanticServices.getTypeChecker().isSubtypeOf(returnedType,expectedReturnType)) {
      trace.getErrorHandler().typeMismatch(returnedExpression == null ? expression : returnedExpression,expectedReturnType,returnedType);
    }
  }
  result=JetStandardClasses.getNothingType();
}
