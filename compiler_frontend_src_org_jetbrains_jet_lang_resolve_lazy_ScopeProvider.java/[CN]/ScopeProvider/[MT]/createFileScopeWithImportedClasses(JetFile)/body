{
  NamespaceDescriptor packageDescriptor=getFilePackageDescriptor(file);
  WritableScope fileScope=new WritableScopeImpl(JetScope.EMPTY,packageDescriptor,RedeclarationHandler.DO_NOTHING,"File scope for declaration resolution with only classes imported");
  fileScope.changeLockLevel(WritableScope.LockLevel.BOTH);
  NamespaceDescriptor rootPackageDescriptor=resolveSession.getPackageDescriptorByFqName(FqName.ROOT);
  if (rootPackageDescriptor == null) {
    throw new IllegalStateException("Root package not found");
  }
  if (!packageDescriptor.getQualifiedName().equals(FqName.ROOT)) {
    fileScope.importScope(rootPackageDescriptor.getMemberScope());
  }
  ImportsResolver.processImportsInFile(true,fileScope,Lists.newArrayList(file.getImportDirectives()),rootPackageDescriptor.getMemberScope(),resolveSession.getModuleConfiguration(),resolveSession.getTrace(),resolveSession.getInjector().getQualifiedExpressionResolver());
  fileScope.changeLockLevel(WritableScope.LockLevel.READING);
  return new ChainedScope(packageDescriptor,packageDescriptor.getMemberScope(),fileScope);
}
