{
  JetNamespaceHeader header=file.getNamespaceHeader();
  if (header == null) {
    throw new IllegalArgumentException("Scripts are not supported: " + file.getName());
  }
  FqName fqName=new FqName(header.getQualifiedName());
  NamespaceDescriptor packageDescriptor=resolveSession.getPackageDescriptorByFqName(fqName);
  if (packageDescriptor == null) {
    throw new IllegalStateException("Package not found: " + fqName + " maybe the file is not in scope of this resolve session: "+ file.getName());
  }
  WritableScope writableScope=new WritableScopeImpl(JetScope.EMPTY,packageDescriptor,RedeclarationHandler.DO_NOTHING,"File scope for declaration resolution");
  NamespaceDescriptor rootPackageDescriptor=resolveSession.getPackageDescriptorByFqName(FqName.ROOT);
  if (rootPackageDescriptor == null) {
    throw new IllegalStateException("Root package not found");
  }
  writableScope.importScope(rootPackageDescriptor.getMemberScope());
  if (!packageDescriptor.getQualifiedName().equals(FqName.ROOT)) {
    writableScope.importScope(packageDescriptor.getMemberScope());
  }
  List<JetImportDirective> importDirectives=Lists.newArrayList(file.getImportDirectives());
  ImportsResolver.processImportsInFile(true,writableScope,importDirectives,rootPackageDescriptor.getMemberScope(),resolveSession.getModuleConfiguration(),resolveSession.getTrace(),resolveSession.getInjector().getQualifiedExpressionResolver());
  writableScope.changeLockLevel(WritableScope.LockLevel.READING);
  return writableScope;
}
