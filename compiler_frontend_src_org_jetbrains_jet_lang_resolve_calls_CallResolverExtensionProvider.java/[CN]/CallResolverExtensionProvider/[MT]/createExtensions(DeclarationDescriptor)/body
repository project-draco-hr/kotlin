{
  Map<DeclarationDescriptor,List<CallResolverExtension>> map;
  if (extensionsCache == null || (map=extensionsCache.get()) == null) {
    map=new HashMap<DeclarationDescriptor,List<CallResolverExtension>>();
    extensionsCache=new WeakReference<Map<DeclarationDescriptor,List<CallResolverExtension>>>(map);
  }
  List<CallResolverExtension> extensions=map.get(declaration);
  if (extensions != null) {
    return extensions;
  }
  extensions=new ArrayList<CallResolverExtension>();
  DeclarationDescriptor parent=declaration.getContainingDeclaration();
  if (parent != null) {
    extensions.addAll(createExtensions(parent));
    extensions.remove(extensions.size() - 1);
  }
  appendExtensionsFor(declaration,extensions);
  List<CallResolverExtension> immutableResult=Collections.unmodifiableList(extensions);
  map.put(declaration,immutableResult);
  return immutableResult;
}
