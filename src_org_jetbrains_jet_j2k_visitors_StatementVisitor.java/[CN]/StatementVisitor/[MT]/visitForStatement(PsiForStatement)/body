{
  super.visitForStatement(statement);
  final PsiStatement initialization=statement.getInitialization();
  final PsiStatement update=statement.getUpdate();
  final PsiExpression condition=statement.getCondition();
  final PsiStatement body=statement.getBody();
  final PsiLocalVariable firstChild=initialization != null && initialization.getFirstChild() instanceof PsiLocalVariable ? (PsiLocalVariable)initialization.getFirstChild() : null;
  int bodyWriteCount=countWritingAccesses(firstChild,body);
  int conditionWriteCount=countWritingAccesses(firstChild,condition);
  int updateWriteCount=countWritingAccesses(firstChild,update);
  boolean onceWritableIterator=updateWriteCount == 1 && bodyWriteCount + conditionWriteCount == 0;
  final IElementType operationTokenType=condition != null && condition instanceof PsiBinaryExpression ? ((PsiBinaryExpression)condition).getOperationTokenType() : null;
  if (initialization != null && initialization instanceof PsiDeclarationStatement && initialization.getFirstChild() == initialization.getLastChild() && condition != null && update != null && update.getChildren().length == 1 && isPlusPlusExpression(update.getChildren()[0]) && operationTokenType != null && (operationTokenType == JavaTokenType.LT || operationTokenType == JavaTokenType.LE) && initialization.getFirstChild() != null && initialization.getFirstChild() instanceof PsiLocalVariable && firstChild != null && firstChild.getNameIdentifier() != null && onceWritableIterator) {
    final Expression end=getConverter().expressionToExpression(((PsiBinaryExpression)condition).getROperand());
    final Expression endExpression=operationTokenType == JavaTokenType.LT ? new BinaryExpression(end,new Identifier("1"),"-") : end;
    myResult=new ForeachWithRangeStatement(new org.jetbrains.jet.j2k.ast.Identifier(firstChild.getName()),getConverter().expressionToExpression(firstChild.getInitializer()),endExpression,getConverter().statementToStatement(body));
  }
 else {
    List<Statement> forStatements=new LinkedList<Statement>();
    forStatements.add(getConverter().statementToStatement(initialization));
    forStatements.add(new WhileStatement(getConverter().expressionToExpression(condition),new Block(Arrays.asList(getConverter().statementToStatement(body),new Block(Arrays.asList(getConverter().statementToStatement(update)),false)),false)));
    myResult=new Block(forStatements,false);
  }
}
