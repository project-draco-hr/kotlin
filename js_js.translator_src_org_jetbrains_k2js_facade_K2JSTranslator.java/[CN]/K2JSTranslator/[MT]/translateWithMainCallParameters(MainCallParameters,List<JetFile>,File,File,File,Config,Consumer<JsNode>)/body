{
  K2JSTranslator translator=new K2JSTranslator(config);
  TextOutputImpl output=new TextOutputImpl();
  SourceMapBuilder sourceMapBuilder=config.isSourcemap() ? new SourceMap3Builder(outputFile,output,new SourceMapBuilderConsumer()) : null;
  Status<String> codeStatus=translator.generateProgramCode(files,mainCall,output,sourceMapBuilder,astConsumer);
  if (codeStatus.isFail())   return Status.fail();
  String programCode=codeStatus.getResult();
  String prefix=FileUtilsPackage.readTextOrEmpty(outputPrefixFile);
  String postfix=FileUtilsPackage.readTextOrEmpty(outputPostfixFile);
  List<File> sourceFiles=ContainerUtil.map(files,new Function<JetFile,File>(){
    @Override public File fun(    JetFile file){
      VirtualFile virtualFile=file.getOriginalFile().getVirtualFile();
      if (virtualFile == null)       return new File(file.getName());
      return VfsUtilCore.virtualToIoFile(virtualFile);
    }
  }
);
  SimpleOutputFile jsFile=new SimpleOutputFile(sourceFiles,outputFile.getName(),prefix + programCode + postfix);
  List<SimpleOutputFile> outputFiles=new SmartList<SimpleOutputFile>(jsFile);
  if (sourceMapBuilder != null) {
    sourceMapBuilder.skipLinesAtBeginning(StringUtil.getLineBreakCount(prefix));
    SimpleOutputFile sourceMapFile=new SimpleOutputFile(sourceFiles,sourceMapBuilder.getOutFile().getName(),sourceMapBuilder.build());
    outputFiles.add(sourceMapFile);
  }
  OutputFileCollection outputFileCollection=new SimpleOutputFileCollection(outputFiles);
  return Status.success(outputFileCollection);
}
