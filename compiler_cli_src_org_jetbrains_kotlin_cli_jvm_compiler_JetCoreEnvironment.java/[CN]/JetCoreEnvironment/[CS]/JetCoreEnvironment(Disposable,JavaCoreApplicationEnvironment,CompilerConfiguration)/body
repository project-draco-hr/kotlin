{
  this.configuration=configuration.copy();
  this.configuration.setReadOnly(true);
  projectEnvironment=new JavaCoreProjectEnvironment(parentDisposable,applicationEnvironment);
  MockProject project=projectEnvironment.getProject();
  annotationsManager=new CoreExternalAnnotationsManager(project.getComponent(PsiManager.class));
  project.registerService(ExternalAnnotationsManager.class,annotationsManager);
  project.registerService(DeclarationProviderFactoryService.class,new CliDeclarationProviderFactoryService(sourceFiles));
  registerProjectServicesForCLI(projectEnvironment);
  registerProjectServices(projectEnvironment);
  for (  File path : configuration.getList(JVMConfigurationKeys.CLASSPATH_KEY)) {
    addToClasspath(path);
  }
  for (  File path : configuration.getList(JVMConfigurationKeys.ANNOTATIONS_PATH_KEY)) {
    addExternalAnnotationsRoot(path);
  }
  sourceFiles.addAll(CompileEnvironmentUtil.getJetFiles(getProject(),getSourceRootsCheckingForDuplicates(),new Function1<String,Unit>(){
    @Override public Unit invoke(    String s){
      report(ERROR,s);
      return Unit.INSTANCE$;
    }
  }
));
  JetScriptDefinitionProvider.getInstance(project).addScriptDefinitions(configuration.getList(CommonConfigurationKeys.SCRIPT_DEFINITIONS_KEY));
  project.registerService(VirtualFileFinderFactory.class,new CliVirtualFileFinderFactory(classPath));
}
