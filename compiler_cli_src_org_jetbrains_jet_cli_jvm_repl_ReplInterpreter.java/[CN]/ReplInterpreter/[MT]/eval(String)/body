{
  ++lineNumber;
  JvmClassName scriptClassName=JvmClassName.byInternalName("Line" + lineNumber);
  StringBuilder fullText=new StringBuilder();
  for (  String prevLine : previousIncompleteLines) {
    fullText.append(prevLine + "\n");
  }
  fullText.append(line);
  LightVirtualFile virtualFile=new LightVirtualFile("line" + lineNumber + ".ktscript",JetLanguage.INSTANCE,fullText.toString());
  virtualFile.setCharset(CharsetToolkit.UTF8_CHARSET);
  JetFile psiFile=(JetFile)((PsiFileFactoryImpl)PsiFileFactory.getInstance(jetCoreEnvironment.getProject())).trySetupPsiForFile(virtualFile,JetLanguage.INSTANCE,true,false);
  MessageCollectorToString errorCollector=new MessageCollectorToString();
  AnalyzerWithCompilerReport.SyntaxErrorReport syntaxErrorReport=AnalyzerWithCompilerReport.reportSyntaxErrors(psiFile,errorCollector);
  if (syntaxErrorReport.isOnlyErrorAtEof()) {
    previousIncompleteLines.add(line);
    return LineResult.incomplete();
  }
  previousIncompleteLines.clear();
  if (syntaxErrorReport.isHasErrors()) {
    return LineResult.error(errorCollector.getString());
  }
  injector.getTopDownAnalyzer().prepareForTheNextReplLine();
  trace.clearDiagnostics();
  psiFile.getScript().putUserData(ScriptHeaderResolver.PRIORITY_KEY,lineNumber);
  ScriptDescriptor scriptDescriptor=doAnalyze(psiFile,errorCollector);
  if (scriptDescriptor == null) {
    return LineResult.error(errorCollector.getString());
  }
  List<Pair<ScriptDescriptor,JvmClassName>> earierScripts=Lists.newArrayList();
  for (  EarlierLine earlierLine : earlierLines) {
    earierScripts.add(Pair.create(earlierLine.getScriptDescriptor(),earlierLine.getClassName()));
  }
  BindingContext bindingContext=AnalyzeExhaust.success(trace.getBindingContext(),module).getBindingContext();
  GenerationState generationState=new GenerationState(psiFile.getProject(),ClassBuilderFactories.binaries(false),bindingContext,Collections.singletonList(psiFile));
  generationState.getScriptCodegen().compileScript(psiFile.getScript(),scriptClassName,earierScripts,CompilationErrorHandler.THROW_EXCEPTION);
  for (  String file : generationState.getFactory().files()) {
    classLoader.addClass(JvmClassName.byInternalName(file.replaceFirst("\\.class$","")),generationState.getFactory().asBytes(file));
  }
  try {
    Class<?> scriptClass=classLoader.loadClass(scriptClassName.getFqName().getFqName());
    Class<?>[] constructorParams=new Class<?>[earlierLines.size()];
    Object[] constructorArgs=new Object[earlierLines.size()];
    for (int i=0; i < earlierLines.size(); ++i) {
      constructorParams[i]=earlierLines.get(i).getScriptClass();
      constructorArgs[i]=earlierLines.get(i).getScriptInstance();
    }
    Constructor<?> scriptInstanceConstructor=scriptClass.getConstructor(constructorParams);
    Object scriptInstance;
    try {
      scriptInstance=scriptInstanceConstructor.newInstance(constructorArgs);
    }
 catch (    Throwable e) {
      return LineResult.error(Throwables.getStackTraceAsString(e));
    }
    Field rvField=scriptClass.getDeclaredField("rv");
    rvField.setAccessible(true);
    Object rv=rvField.get(scriptInstance);
    earlierLines.add(new EarlierLine(line,scriptDescriptor,scriptClass,scriptInstance,scriptClassName));
    return LineResult.successful(rv,scriptDescriptor.getReturnType().equals(KotlinBuiltIns.getInstance().getUnitType()));
  }
 catch (  Throwable e) {
    PrintWriter writer=new PrintWriter(System.err);
    classLoader.dumpClasses(writer);
    writer.flush();
    throw ExceptionUtils.rethrow(e);
  }
}
