{
  WritableScope scope=new WritableScopeImpl(JetScope.EMPTY,module,new TraceBasedRedeclarationHandler(trace),"Root scope in analyzePackage");
  scope.changeLockLevel(WritableScope.LockLevel.BOTH);
  scope.importScope(module.getPackage(FqName.ROOT).getMemberScope());
  if (lastLineScope != null) {
    scope.importScope(lastLineScope);
  }
  scope.changeLockLevel(WritableScope.LockLevel.READING);
  injector.getTopDownAnalyzer().doProcess(topDownAnalysisContext,scope,new PackageLikeBuilderDummy(),Collections.singletonList(psiFile));
  boolean hasErrors=AnalyzerWithCompilerReport.reportDiagnostics(trace.getBindingContext().getDiagnostics(),messageCollector);
  if (hasErrors) {
    return null;
  }
  ScriptDescriptor scriptDescriptor=topDownAnalysisContext.getScripts().get(psiFile.getScript());
  lastLineScope=trace.get(BindingContext.SCRIPT_SCOPE,scriptDescriptor);
  if (lastLineScope == null) {
    throw new IllegalStateException("last line scope is not initialized");
  }
  return scriptDescriptor;
}
