{
  final WritableScope scope=new WritableScopeImpl(JetScope.EMPTY,module,new TraceBasedRedeclarationHandler(trace),"Root scope in analyzeNamespace");
  scope.changeLockLevel(WritableScope.LockLevel.BOTH);
  NamespaceDescriptorImpl rootNs=injector.getNamespaceFactory().createNamespaceDescriptorPathIfNeeded(FqName.ROOT);
  injector.getNamespaceFactory().createNamespaceDescriptorPathIfNeeded(JetStandardClasses.STANDARD_CLASSES_FQNAME);
  scope.importScope(rootNs.getMemberScope());
  if (lastLineScope != null) {
    scope.importScope(lastLineScope);
  }
  scope.changeLockLevel(WritableScope.LockLevel.READING);
  injector.getTopDownAnalyzer().doProcess(scope,new NamespaceLikeBuilderDummy(),Collections.singletonList(psiFile));
  AnalyzingUtils.throwExceptionOnErrors(trace.getBindingContext());
  ScriptDescriptor scriptDescriptor=injector.getTopDownAnalysisContext().getScripts().get(psiFile.getScript());
  lastLineScope=trace.get(BindingContext.SCRIPT_SCOPE,scriptDescriptor);
  if (lastLineScope == null) {
    throw new IllegalStateException("last line scope is not initialized");
  }
  return scriptDescriptor;
}
