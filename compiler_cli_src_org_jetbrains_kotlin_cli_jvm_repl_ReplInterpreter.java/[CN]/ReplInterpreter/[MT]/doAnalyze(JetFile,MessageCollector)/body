{
  scriptDeclarationFactory.setDelegateFactory(new FileBasedDeclarationProviderFactory(topDownAnalysisContext.getStorageManager(),Collections.singletonList(psiFile)));
  TopDownAnalysisContext context=topDownAnalyzer.analyzeDeclarations(topDownAnalysisContext.getTopDownAnalysisParameters(),Collections.singletonList(psiFile),DataFlowInfo.EMPTY);
  if (trace.get(BindingContext.FILE_TO_PACKAGE_FRAGMENT,psiFile) == null) {
    trace.record(BindingContext.FILE_TO_PACKAGE_FRAGMENT,psiFile,resolveSession.getPackageFragment(FqName.ROOT));
  }
  boolean hasErrors=AnalyzerWithCompilerReport.reportDiagnostics(trace.getBindingContext().getDiagnostics(),messageCollector);
  if (hasErrors) {
    return null;
  }
  ScriptDescriptor scriptDescriptor=context.getScripts().get(psiFile.getScript());
  lastLineScope=trace.get(BindingContext.SCRIPT_SCOPE,scriptDescriptor);
  if (lastLineScope == null) {
    throw new IllegalStateException("last line scope is not initialized");
  }
  return scriptDescriptor;
}
