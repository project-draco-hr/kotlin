{
  scriptDeclarationFactory.setDelegateFactory(new FileBasedDeclarationProviderFactory(resolveSession.getStorageManager(),Collections.singletonList(psiFile)));
  TopDownAnalysisContext context=topDownAnalyzer.analyzeDeclarations(topDownAnalysisContext.getTopDownAnalysisMode(),Collections.singletonList(psiFile));
  if (trace.get(BindingContext.FILE_TO_PACKAGE_FRAGMENT,psiFile) == null) {
    trace.record(BindingContext.FILE_TO_PACKAGE_FRAGMENT,psiFile,resolveSession.getPackageFragment(FqName.ROOT));
  }
  boolean hasErrors=AnalyzerWithCompilerReport.Companion.reportDiagnostics(trace.getBindingContext().getDiagnostics(),errorReporter,false);
  if (hasErrors) {
    return null;
  }
  LazyScriptDescriptor scriptDescriptor=context.getScripts().get(psiFile.getScript());
  lastLineScope=scriptDescriptor.getScopeForInitializerResolution();
  return scriptDescriptor;
}
