{
  ProtoBuf.Package.Builder builder=ProtoBuf.Package.newBuilder();
  Collection<DeclarationDescriptor> members=new ArrayList<DeclarationDescriptor>();
  for (  PackageFragmentDescriptor fragment : fragments) {
    members.addAll(fragment.getMemberScope().getAllDescriptors());
  }
  for (  DeclarationDescriptor declaration : sort(members)) {
    if (skip != null && skip.invoke(declaration))     continue;
    if (declaration instanceof PropertyDescriptor || declaration instanceof FunctionDescriptor) {
      builder.addMember(callableProto((CallableMemberDescriptor)declaration));
    }
    if (declaration instanceof PropertyDescriptor) {
      builder.addProperty(propertyProto((PropertyDescriptor)declaration));
    }
 else     if (declaration instanceof FunctionDescriptor) {
      builder.addFunction(functionProto((FunctionDescriptor)declaration));
    }
  }
  extension.serializePackage(fragments,builder);
  return builder;
}
