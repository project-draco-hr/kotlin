{
  if (lookupResults.isEmpty()) {
    return Collections.emptyList();
  }
  Collection<DeclarationDescriptor> descriptors=Sets.newLinkedHashSet();
  for (  LookupResult lookupResult : lookupResults) {
    descriptors.addAll(lookupResult.descriptors);
  }
  Collection<DeclarationDescriptor> filteredDescriptors;
  if (lookupMode == LookupMode.ONLY_CLASSES_AND_PACKAGES) {
    filteredDescriptors=Collections2.filter(descriptors,CLASSIFIERS_AND_PACKAGE_VIEWS);
  }
 else {
    filteredDescriptors=Sets.newLinkedHashSet();
    for (    LookupResult lookupResult : lookupResults) {
      if (lookupResult.packageLevel) {
        filteredDescriptors.addAll(lookupResult.descriptors);
      }
 else {
        filteredDescriptors.addAll(Collections2.filter(lookupResult.descriptors,CLASSIFIERS_AND_PACKAGE_VIEWS));
      }
    }
  }
  if (storeResult) {
    Collection<JetScope> possibleResolutionScopes=Lists.newArrayList();
    for (    LookupResult lookupResult : lookupResults) {
      if (!lookupResult.descriptors.isEmpty()) {
        possibleResolutionScopes.add(lookupResult.resolutionScope);
      }
    }
    if (possibleResolutionScopes.isEmpty()) {
      for (      LookupResult lookupResult : lookupResults) {
        possibleResolutionScopes.add(lookupResult.resolutionScope);
      }
    }
    storeResolutionResult(descriptors,filteredDescriptors,referenceExpression,possibleResolutionScopes,trace,shouldBeVisibleFrom);
  }
  return filteredDescriptors;
}
