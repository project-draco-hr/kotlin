{
  ImportResolveStatus status=importResolveStatus;
  if (status != null && (status.lookupMode == mode || status.lookupMode == LookupMode.EVERYTHING)) {
    return status.scope;
  }
  return resolveSession.getStorageManager().compute(new Function0<JetScope>(){
    @Override public JetScope invoke(){
      ImportResolveStatus cachedStatus=importResolveStatus;
      if (cachedStatus != null && (cachedStatus.lookupMode == mode || cachedStatus.lookupMode == LookupMode.EVERYTHING)) {
        return cachedStatus.scope;
      }
      WritableScope directiveImportScope=new WritableScopeImpl(JetScope.EMPTY,packageDescriptor,RedeclarationHandler.DO_NOTHING,"Scope for import '" + directive.getText() + "' resolve in "+ toString());
      directiveImportScope.changeLockLevel(WritableScope.LockLevel.BOTH);
      Importer.StandardImporter importer=new Importer.StandardImporter(directiveImportScope);
      directiveUnderResolve=directive;
      Collection<? extends DeclarationDescriptor> descriptors;
      try {
        descriptors=resolveSession.getQualifiedExpressionResolver().processImportReference(directive,rootScope,packageDescriptor.getMemberScope(),importer,traceForImportResolve,resolveSession.getModuleDescriptor(),mode);
        if (mode == LookupMode.EVERYTHING) {
          ImportsResolver.checkPlatformTypesMappedToKotlin(packageDescriptor.getModule(),traceForImportResolve,directive,descriptors);
        }
      }
  finally {
        directiveUnderResolve=null;
        directiveImportScope.changeLockLevel(WritableScope.LockLevel.READING);
      }
      importResolveStatus=new ImportResolveStatus(mode,directiveImportScope,descriptors);
      return directiveImportScope;
    }
  }
);
}
