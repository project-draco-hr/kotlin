{
  MutablePackageFragmentDescriptor packageFragment=namespaceFactory.createPackageFragmentIfNeeded(file);
  context.getPackageFragments().put(file,packageFragment);
  PackageViewDescriptor packageView=packageFragment.getContainingDeclaration().getPackage(packageFragment.getFqName());
  ChainedScope rootPlusPackageScope=new ChainedScope(packageView,"Root scope for " + file,packageView.getMemberScope(),outerScope);
  WriteThroughScope packageScope=new WriteThroughScope(rootPlusPackageScope,packageFragment.getMemberScope(),new TraceBasedRedeclarationHandler(trace),"package in file " + file.getName());
  packageScope.changeLockLevel(WritableScope.LockLevel.BOTH);
  context.getNamespaceScopes().put(file,packageScope);
  if (file.isScript()) {
    scriptHeaderResolver.processScriptHierarchy(file.getScript(),packageScope);
  }
  prepareForDeferredCall(packageScope,packageFragment,file);
}
