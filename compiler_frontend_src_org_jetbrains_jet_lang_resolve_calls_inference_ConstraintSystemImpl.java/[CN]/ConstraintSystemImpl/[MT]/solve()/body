{
  for (  Map.Entry<JetType,KnownType> entry : Sets.newHashSet(knownTypes.entrySet())) {
    JetType jetType=entry.getKey();
    KnownType typeValue=entry.getValue();
    for (    TypeValue upperBound : typeValue.getUpperBounds()) {
      if (upperBound instanceof KnownType) {
        KnownType knownBoundType=(KnownType)upperBound;
        boolean ok=constraintExpander.isSubtypeOf(jetType,knownBoundType.getType());
        if (!ok) {
          listener.error("Error while expanding '" + jetType + " :< "+ knownBoundType.getType()+ "'");
          return new Solution().registerError("Mismatch while expanding constraints");
        }
      }
    }
  }
  for (  Map.Entry<TypeParameterDescriptor,UnknownType> entry : Sets.newHashSet(unknownTypes.entrySet())) {
    TypeParameterDescriptor typeParameterDescriptor=entry.getKey();
    UnknownType typeValue=entry.getValue();
    for (    JetType upperBound : typeParameterDescriptor.getUpperBounds()) {
      addSubtypingConstraintOnTypeValues(typeValue,getTypeValueFor(upperBound));
    }
  }
  Set<TypeValue> visited=Sets.newHashSet();
  for (  UnknownType unknownType : unknownTypes.values()) {
    transitiveClosure(unknownType,visited);
  }
  for (  UnknownType unknownType : unknownTypes.values()) {
    listener.constraintsForUnknown(unknownType.getTypeParameterDescriptor(),unknownType);
  }
  for (  KnownType knownType : knownTypes.values()) {
    listener.constraintsForKnownType(knownType.getType(),knownType);
  }
  Solution solution=new Solution();
  for (  UnknownType unknownType : unknownTypes.values()) {
    check(unknownType,solution);
  }
  for (  KnownType knownType : knownTypes.values()) {
    check(knownType,solution);
  }
  listener.done(solution,unknownTypes.keySet());
  return solution;
}
