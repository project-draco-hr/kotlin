{
  FqName fqName;
  NamespaceDescriptorImpl namespaceDescriptor;
  if (root) {
    if (!(owner instanceof ModuleDescriptor)) {
      throw new IllegalStateException();
    }
    fqName=FqName.ROOT;
    namespaceDescriptor=(NamespaceDescriptorImpl)trace.get(BindingContext.FQNAME_TO_NAMESPACE_DESCRIPTOR,FqName.ROOT);
  }
 else {
    FqName ownerFqName=DescriptorUtils.getFQName(owner).toSafe();
    fqName=ownerFqName.child(name);
    namespaceDescriptor=((NamespaceDescriptorImpl)owner).getNamespace(name);
  }
  if (namespaceDescriptor == null) {
    namespaceDescriptor=new NamespaceDescriptorImpl(owner,Collections.<AnnotationDescriptor>emptyList(),name);
    trace.record(FQNAME_TO_NAMESPACE_DESCRIPTOR,fqName,namespaceDescriptor);
    WritableScopeImpl scope=new WritableScopeImpl(JetScope.EMPTY,namespaceDescriptor,new TraceBasedRedeclarationHandler(trace)).setDebugName("Namespace member scope");
    scope.changeLockLevel(WritableScope.LockLevel.BOTH);
    namespaceDescriptor.initialize(scope);
    configuration.extendNamespaceScope(trace,namespaceDescriptor,scope);
    owner.addNamespace(namespaceDescriptor);
    if (declaration != null) {
      trace.record(BindingContext.NAMESPACE,declaration,namespaceDescriptor);
    }
  }
  if (file != null) {
    trace.record(BindingContext.FILE_TO_NAMESPACE,file,namespaceDescriptor);
  }
  return namespaceDescriptor;
}
