{
  FqName fqName;
  NamespaceDescriptorImpl namespaceDescriptor;
  if (root) {
    if (!(owner instanceof ModuleDescriptor)) {
      throw new IllegalStateException();
    }
    fqName=FqName.ROOT;
    namespaceDescriptor=((ModuleDescriptor)owner).getRootNs();
  }
 else {
    FqName ownerFqName=DescriptorUtils.getFQName(owner).toSafe();
    fqName=ownerFqName.child(name);
    namespaceDescriptor=((NamespaceDescriptorImpl)owner).getNamespace(name);
  }
  if (namespaceDescriptor == null) {
    namespaceDescriptor=new NamespaceDescriptorImpl(owner,Collections.<AnnotationDescriptor>emptyList(),name);
    trace.record(FQNAME_TO_NAMESPACE_DESCRIPTOR,fqName,namespaceDescriptor);
    WritableScopeImpl scope=new WritableScopeImpl(JetScope.EMPTY,namespaceDescriptor,RedeclarationHandler.DO_NOTHING).setDebugName("Namespace member scope");
    scope.changeLockLevel(WritableScope.LockLevel.BOTH);
    namespaceDescriptor.initialize(scope);
    configuration.extendNamespaceScope(trace,namespaceDescriptor,scope);
    owner.addNamespace(namespaceDescriptor);
    if (expression != null) {
      trace.record(BindingContext.NAMESPACE,expression,namespaceDescriptor);
    }
  }
  if (expression != null) {
    trace.record(REFERENCE_TARGET,expression,namespaceDescriptor);
  }
  if (file != null) {
    trace.record(BindingContext.FILE_TO_NAMESPACE,file,namespaceDescriptor);
    Collection<JetFile> files=trace.get(NAMESPACE_TO_FILES,namespaceDescriptor);
    if (files == null) {
      files=Sets.newIdentityHashSet();
    }
    files.add(file);
    trace.record(BindingContext.NAMESPACE_TO_FILES,namespaceDescriptor,files);
  }
  return namespaceDescriptor;
}
