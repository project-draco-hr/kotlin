{
  final JetExpression loopRange=expression.getLoopRange();
  FunctionDescriptor iteratorDescriptor=bindingContext.get(BindingContext.LOOP_RANGE_ITERATOR,loopRange);
  FunctionDescriptor nextDescriptor=bindingContext.get(BindingContext.LOOP_RANGE_NEXT,loopRange);
  DeclarationDescriptor hasNextDescriptor=bindingContext.get(BindingContext.LOOP_RANGE_HAS_NEXT,loopRange);
  if (iteratorDescriptor == null)   throw new IllegalStateException("No iterator() method " + DiagnosticUtils.atLocation(loopRange));
  if (nextDescriptor == null)   throw new IllegalStateException("No next() method " + DiagnosticUtils.atLocation(loopRange));
  if (hasNextDescriptor == null)   throw new IllegalStateException("No hasNext method or property" + DiagnosticUtils.atLocation(loopRange));
  final JetParameter loopParameter=expression.getLoopParameter();
  final VariableDescriptor parameterDescriptor=bindingContext.get(BindingContext.VALUE_PARAMETER,loopParameter);
  JetType iteratorType=iteratorDescriptor.getReturnType();
  Type asmIterType=boxType(asmType(iteratorType));
  JetType paramType=parameterDescriptor.getOutType();
  Type asmParamType=asmType(paramType);
  int iteratorVar=myFrameMap.enterTemp();
  gen(expression.getLoopRange(),loopRangeType);
  invokeFunctionNoParams(iteratorDescriptor,asmIterType,v);
  v.store(iteratorVar,asmIterType);
  Label end=new Label();
  if (iteratorType.isNullable()) {
    v.load(iteratorVar,TYPE_OBJECT);
    v.ifnull(end);
  }
  Label begin=new Label();
  blockStackElements.push(new LoopBlockStackElement(end,begin,targetLabel(expression)));
  v.mark(begin);
  v.load(iteratorVar,asmIterType);
  if (hasNextDescriptor instanceof FunctionDescriptor) {
    FunctionDescriptor hND=(FunctionDescriptor)hasNextDescriptor;
    invokeFunctionNoParams(hND,Type.BOOLEAN_TYPE,v);
  }
 else {
    intermediateValueForProperty((PropertyDescriptor)hasNextDescriptor,false,null).put(Type.BOOLEAN_TYPE,v);
  }
  v.ifeq(end);
  myFrameMap.enter(parameterDescriptor,asmParamType.getSize());
  v.load(iteratorVar,asmIterType);
  invokeFunctionNoParams(nextDescriptor,asmParamType,v);
  if (asmParamType.getSort() == Type.OBJECT && !"java.lang.Object".equals(asmParamType.getClassName())) {
    v.checkcast(asmParamType);
  }
  v.store(lookupLocal(parameterDescriptor),asmParamType);
  gen(expression.getBody(),Type.VOID_TYPE);
  v.goTo(begin);
  v.mark(end);
  int paramIndex=myFrameMap.leave(parameterDescriptor);
  v.visitLocalVariable(loopParameter.getName(),asmParamType.getDescriptor(),null,begin,end,paramIndex);
  myFrameMap.leaveTemp();
  blockStackElements.pop();
}
