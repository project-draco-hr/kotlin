{
  extend(CompletionType.BASIC,PlatformPatterns.psiElement(),new CompletionProvider<CompletionParameters>(){
    @Override protected void addCompletions(    @NotNull CompletionParameters parameters,    ProcessingContext context,    @NotNull final CompletionResultSet result){
      if (parameters.getInvocationCount() == 0)       return;
      PsiFile file=parameters.getPosition().getContainingFile();
      int offset=parameters.getOffset();
      final List<TemplateImpl> templates=listApplicableTemplates(file,offset);
      final Ref<Boolean> templatesShown=Ref.create(false);
      result.runRemainingContributors(parameters,new Consumer<CompletionResult>(){
        @Override public void consume(        CompletionResult completionResult){
          result.passResult(completionResult);
          ensureTemplatesShown(templatesShown,templates,result);
        }
      }
);
      ensureTemplatesShown(templatesShown,templates,result);
    }
  }
);
}
