{
  CompilerSpecialMode mode=parseCompilerSpecialMode(arguments);
  File[] altHeadersClasspath;
  if (mode.includeAltHeaders()) {
    File path=PathUtil.getAltHeadersPath();
    File[] defaultAltHeadersPathArray;
    if (path != null) {
      defaultAltHeadersPathArray=new File[]{path};
    }
 else {
      defaultAltHeadersPathArray=new File[0];
    }
    if (arguments.altHeaders != null) {
      File[] files=pathsToFiles(arguments.altHeaders);
      altHeadersClasspath=ArrayUtil.mergeArrays(files,defaultAltHeadersPathArray);
    }
 else {
      altHeadersClasspath=defaultAltHeadersPathArray;
    }
  }
 else {
    altHeadersClasspath=new File[0];
  }
  File runtimeJar;
  if (mode.includeKotlinRuntime()) {
    if (arguments.stdlib != null) {
      runtimeJar=new File(arguments.stdlib);
    }
 else {
      runtimeJar=PathUtil.getDefaultRuntimePath();
    }
  }
 else {
    runtimeJar=null;
  }
  CompilerDependencies dependencies=new CompilerDependencies(mode,CompilerDependencies.findRtJar(),altHeadersClasspath,runtimeJar);
  JetCoreEnvironment environment=JetCoreEnvironment.getCoreEnvironmentForJVM(rootDisposable,dependencies);
  K2JVMCompileEnvironmentConfiguration configuration=new K2JVMCompileEnvironmentConfiguration(environment,messageCollector);
  messageCollector.report(CompilerMessageSeverity.LOGGING,"Configuring the compilation environment",CompilerMessageLocation.NO_LOCATION);
  try {
    configureEnvironment(configuration,arguments);
    boolean noErrors;
    if (arguments.module != null) {
      boolean oldVerbose=messageCollector.isVerbose();
      messageCollector.setVerbose(false);
      List<Module> modules=CompileEnvironmentUtil.loadModuleScript(arguments.module,messageCollector);
      messageCollector.setVerbose(oldVerbose);
      File directory=new File(arguments.module).getParentFile();
      noErrors=KotlinToJVMBytecodeCompiler.compileModules(configuration,modules,directory,arguments.jar,arguments.outputDir,arguments.includeRuntime);
    }
 else {
      if (arguments.getSourceDirs() != null) {
        noErrors=KotlinToJVMBytecodeCompiler.compileBunchOfSourceDirectories(configuration,arguments.getSourceDirs(),arguments.jar,arguments.outputDir,arguments.script,arguments.includeRuntime);
      }
 else {
        List<String> sources=Lists.newArrayList();
        if (arguments.src != null) {
          sources.add(arguments.src);
        }
        sources.addAll(arguments.freeArgs);
        noErrors=KotlinToJVMBytecodeCompiler.compileBunchOfSources(configuration,sources,arguments.jar,arguments.outputDir,arguments.script,arguments.includeRuntime);
      }
    }
    return noErrors ? OK : COMPILATION_ERROR;
  }
 catch (  CompilationException e) {
    messageCollector.report(CompilerMessageSeverity.EXCEPTION,MessageRenderer.PLAIN.renderException(e),MessageUtil.psiElementToMessageLocation(e.getElement()));
    return INTERNAL_ERROR;
  }
catch (  Throwable t) {
    messageCollector.report(CompilerMessageSeverity.EXCEPTION,MessageRenderer.PLAIN.renderException(t),CompilerMessageLocation.NO_LOCATION);
    return INTERNAL_ERROR;
  }
}
