{
  KotlinPaths paths=arguments.kotlinHome != null ? new KotlinPathsFromHomeDir(new File(arguments.kotlinHome)) : PathUtil.getKotlinPathsForCompiler();
  messageCollector.report(CompilerMessageSeverity.LOGGING,"Using Kotlin home directory " + paths.getHomePath(),CompilerMessageLocation.NO_LOCATION);
  CompilerConfiguration configuration=new CompilerConfiguration();
  configuration.addAll(JVMConfigurationKeys.CLASSPATH_KEY,getClasspath(paths,arguments));
  configuration.addAll(JVMConfigurationKeys.ANNOTATIONS_PATH_KEY,getAnnotationsPath(paths,arguments));
  final List<String> argumentsSourceDirs=arguments.getSourceDirs();
  if (!arguments.script && arguments.module == null && arguments.src == null && arguments.freeArgs.isEmpty() && (argumentsSourceDirs == null || argumentsSourceDirs.size() == 0)) {
    ReplFromTerminal.run(rootDisposable,configuration);
    return ExitCode.OK;
  }
 else   if (arguments.module != null) {
  }
 else   if (arguments.script) {
    configuration.add(CommonConfigurationKeys.SOURCE_ROOTS_KEY,arguments.freeArgs.get(0));
  }
 else {
    if (arguments.getSourceDirs() != null) {
      for (      String source : arguments.getSourceDirs()) {
        configuration.add(CommonConfigurationKeys.SOURCE_ROOTS_KEY,source);
      }
    }
 else {
      if (arguments.src != null) {
        List<String> sourcePathsSplitByPathSeparator=Arrays.asList(arguments.src.split(StringUtil.escapeToRegexp(File.pathSeparator)));
        configuration.addAll(CommonConfigurationKeys.SOURCE_ROOTS_KEY,sourcePathsSplitByPathSeparator);
      }
      for (      String freeArg : arguments.freeArgs) {
        configuration.add(CommonConfigurationKeys.SOURCE_ROOTS_KEY,freeArg);
      }
    }
  }
  boolean builtins=arguments.builtins;
  configuration.put(JVMConfigurationKeys.SCRIPT_PARAMETERS,arguments.script ? CommandLineScriptUtils.scriptParameters() : Collections.<AnalyzerScriptParameter>emptyList());
  configuration.put(JVMConfigurationKeys.STUBS,builtins);
  configuration.put(JVMConfigurationKeys.BUILTIN_TO_JAVA_TYPES_MAPPING_KEY,builtins ? BuiltinToJavaTypesMapping.DISABLED : BuiltinToJavaTypesMapping.ENABLED);
  configuration.put(JVMConfigurationKeys.GENERATE_NOT_NULL_ASSERTIONS,arguments.notNullAssertions);
  configuration.put(JVMConfigurationKeys.GENERATE_NOT_NULL_PARAMETER_ASSERTIONS,arguments.notNullParamAssertions);
  configuration.put(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY,messageCollector);
  messageCollector.report(CompilerMessageSeverity.LOGGING,"Configuring the compilation environment",CompilerMessageLocation.NO_LOCATION);
  try {
    configureEnvironment(configuration,arguments);
    File jar=arguments.jar != null ? new File(arguments.jar) : null;
    File outputDir=arguments.outputDir != null ? new File(arguments.outputDir) : null;
    if (arguments.module != null) {
      boolean oldVerbose=messageCollector.isVerbose();
      messageCollector.setVerbose(false);
      List<Module> modules=CompileEnvironmentUtil.loadModuleScript(paths,arguments.module,messageCollector);
      messageCollector.setVerbose(oldVerbose);
      File directory=new File(arguments.module).getParentFile();
      KotlinToJVMBytecodeCompiler.compileModules(configuration,modules,directory,jar,outputDir,arguments.includeRuntime);
    }
 else     if (arguments.script) {
      List<String> scriptArgs=arguments.freeArgs.subList(1,arguments.freeArgs.size());
      JetCoreEnvironment environment=new JetCoreEnvironment(rootDisposable,configuration);
      KotlinToJVMBytecodeCompiler.compileAndExecuteScript(paths,environment,scriptArgs);
    }
 else {
      JetCoreEnvironment environment=new JetCoreEnvironment(rootDisposable,configuration);
      KotlinToJVMBytecodeCompiler.compileBunchOfSources(environment,jar,outputDir,arguments.includeRuntime);
    }
    return messageCollector.anyReported(CompilerMessageSeverity.ERROR) ? COMPILATION_ERROR : OK;
  }
 catch (  CompilationException e) {
    messageCollector.report(CompilerMessageSeverity.EXCEPTION,MessageRenderer.PLAIN.renderException(e),MessageUtil.psiElementToMessageLocation(e.getElement()));
    return INTERNAL_ERROR;
  }
catch (  Throwable t) {
    messageCollector.report(CompilerMessageSeverity.EXCEPTION,MessageRenderer.PLAIN.renderException(t),CompilerMessageLocation.NO_LOCATION);
    return INTERNAL_ERROR;
  }
}
