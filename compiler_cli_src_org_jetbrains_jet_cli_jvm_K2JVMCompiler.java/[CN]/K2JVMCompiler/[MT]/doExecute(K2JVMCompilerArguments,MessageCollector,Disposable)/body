{
  KotlinPaths paths=arguments.kotlinHome != null ? new KotlinPathsFromHomeDir(new File(arguments.kotlinHome)) : PathUtil.getKotlinPathsForCompiler();
  messageCollector.report(CompilerMessageSeverity.LOGGING,"Using Kotlin home directory " + paths.getHomePath(),CompilerMessageLocation.NO_LOCATION);
  CompilerConfiguration configuration=new CompilerConfiguration();
  try {
    configuration.addAll(JVMConfigurationKeys.CLASSPATH_KEY,getClasspath(paths,arguments));
    configuration.addAll(JVMConfigurationKeys.ANNOTATIONS_PATH_KEY,getAnnotationsPath(paths,arguments));
  }
 catch (  Throwable t) {
    MessageCollectorUtil.reportException(messageCollector,t);
    return INTERNAL_ERROR;
  }
  if (!arguments.script && arguments.module == null && arguments.freeArgs.isEmpty() && !arguments.version) {
    ReplFromTerminal.run(rootDisposable,configuration);
    return ExitCode.OK;
  }
 else   if (arguments.module != null) {
  }
 else   if (arguments.script) {
    configuration.add(CommonConfigurationKeys.SOURCE_ROOTS_KEY,arguments.freeArgs.get(0));
  }
 else {
    configuration.addAll(CommonConfigurationKeys.SOURCE_ROOTS_KEY,arguments.freeArgs);
  }
  configuration.put(JVMConfigurationKeys.SCRIPT_PARAMETERS,arguments.script ? CommandLineScriptUtils.scriptParameters() : Collections.<AnalyzerScriptParameter>emptyList());
  configuration.put(JVMConfigurationKeys.GENERATE_NOT_NULL_ASSERTIONS,arguments.notNullAssertions);
  configuration.put(JVMConfigurationKeys.GENERATE_NOT_NULL_PARAMETER_ASSERTIONS,arguments.notNullParamAssertions);
  configuration.put(JVMConfigurationKeys.ENABLE_INLINE,CompilerArgumentsUtil.optionToBooleanFlag(arguments.inline,InlineCodegenUtil.DEFAULT_INLINE_FLAG));
  configuration.put(JVMConfigurationKeys.ENABLE_OPTIMIZATION,CompilerArgumentsUtil.optionToBooleanFlag(arguments.optimize,OptimizationUtils.DEFAULT_OPTIMIZATION_FLAG));
  configuration.put(CLIConfigurationKeys.MESSAGE_COLLECTOR_KEY,messageCollector);
  messageCollector.report(CompilerMessageSeverity.LOGGING,"Configuring the compilation environment",CompilerMessageLocation.NO_LOCATION);
  try {
    configureEnvironment(configuration,arguments);
    File jar=arguments.jar != null ? new File(arguments.jar) : null;
    File outputDir=arguments.outputDir != null ? new File(arguments.outputDir) : null;
    if (arguments.module != null) {
      MessageCollector sanitizedCollector=new FilteringMessageCollector(messageCollector,in(CompilerMessageSeverity.VERBOSE));
      ModuleScriptData moduleScript=CompileEnvironmentUtil.loadModuleDescriptions(paths,arguments.module,sanitizedCollector);
      if (moduleScript.getIncrementalCacheDir() != null) {
        configuration.put(JVMConfigurationKeys.INCREMENTAL_CACHE_BASE_DIR,new File(moduleScript.getIncrementalCacheDir()));
      }
      if (outputDir != null) {
        messageCollector.report(CompilerMessageSeverity.WARNING,"The '-output' option is ignored because '-module' is specified",CompilerMessageLocation.NO_LOCATION);
      }
      File directory=new File(arguments.module).getAbsoluteFile().getParentFile();
      KotlinToJVMBytecodeCompiler.compileModules(configuration,moduleScript.getModules(),directory,jar,arguments.includeRuntime);
    }
 else     if (arguments.script) {
      List<String> scriptArgs=arguments.freeArgs.subList(1,arguments.freeArgs.size());
      JetCoreEnvironment environment=JetCoreEnvironment.createForProduction(rootDisposable,configuration);
      KotlinToJVMBytecodeCompiler.compileAndExecuteScript(paths,environment,scriptArgs);
    }
 else {
      JetCoreEnvironment environment=JetCoreEnvironment.createForProduction(rootDisposable,configuration);
      KotlinToJVMBytecodeCompiler.compileBunchOfSources(environment,jar,outputDir,arguments.includeRuntime);
    }
    return OK;
  }
 catch (  CompilationException e) {
    messageCollector.report(CompilerMessageSeverity.EXCEPTION,MessageRenderer.PLAIN.renderException(e),MessageUtil.psiElementToMessageLocation(e.getElement()));
    return INTERNAL_ERROR;
  }
}
