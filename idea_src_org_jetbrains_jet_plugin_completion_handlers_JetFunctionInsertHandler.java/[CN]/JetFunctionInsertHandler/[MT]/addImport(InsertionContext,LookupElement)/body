{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override public void run(){
      int startOffset=context.getStartOffset();
      PsiElement element=context.getFile().findElementAt(startOffset);
      if (element == null) {
        return;
      }
      if (context.getFile() instanceof JetFile && item.getObject() instanceof JetLookupObject) {
        final DeclarationDescriptor descriptor=((JetLookupObject)item.getObject()).getDescriptor();
        if (descriptor instanceof SimpleFunctionDescriptor) {
          final JetFile file=(JetFile)context.getFile();
          final SimpleFunctionDescriptor functionDescriptor=(SimpleFunctionDescriptor)descriptor;
          if (PsiTreeUtil.getParentOfType(element,JetQualifiedExpression.class) != null && !functionDescriptor.getReceiverParameter().exists()) {
            return;
          }
          if (DescriptorUtils.isTopLevelDeclaration(functionDescriptor)) {
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              @Override public void run(){
                final FqName fqn=DescriptorUtils.getFQName(functionDescriptor).toSafe();
                ImportInsertHelper.addImportDirective(fqn,file);
              }
            }
);
          }
        }
      }
    }
  }
);
}
