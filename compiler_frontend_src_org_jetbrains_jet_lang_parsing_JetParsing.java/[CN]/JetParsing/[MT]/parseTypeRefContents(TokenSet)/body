{
  PsiBuilder.Marker typeRefMarker=mark();
  parseAnnotations(false);
  if (at(IDENTIFIER) || at(PACKAGE_KEYWORD)) {
    parseUserType();
  }
 else   if (at(HASH)) {
    parseTupleType();
  }
 else   if (at(LPAR)) {
    PsiBuilder.Marker functionOrParenthesizedType=mark();
    advance();
    parseTypeRefContents(TokenSet.EMPTY).drop();
    if (at(RPAR)) {
      advance();
      if (at(ARROW)) {
        functionOrParenthesizedType.rollbackTo();
        parseFunctionType();
      }
 else {
        functionOrParenthesizedType.drop();
      }
    }
 else {
      functionOrParenthesizedType.rollbackTo();
      parseFunctionType();
    }
  }
 else   if (at(CAPITALIZED_THIS_KEYWORD)) {
    parseSelfType();
  }
 else {
    errorWithRecovery("Type expected",TokenSet.orSet(TOPLEVEL_OBJECT_FIRST,TokenSet.create(EQ,COMMA,GT,RBRACKET,DOT,RPAR,RBRACE,LBRACE,SEMICOLON),extraRecoverySet));
  }
  while (at(QUEST)) {
    PsiBuilder.Marker precede=typeRefMarker.precede();
    advance();
    typeRefMarker.done(NULLABLE_TYPE);
    typeRefMarker=precede;
  }
  if (at(DOT)) {
    PsiBuilder.Marker functionType=typeRefMarker.precede();
    PsiBuilder.Marker receiverType=typeRefMarker.precede();
    typeRefMarker.done(TYPE_REFERENCE);
    receiverType.done(FUNCTION_TYPE_RECEIVER);
    advance();
    if (at(LPAR)) {
      parseFunctionTypeContents().drop();
    }
 else {
      error("Expecting function type");
    }
    typeRefMarker=functionType.precede();
    functionType.done(FUNCTION_TYPE);
  }
  return typeRefMarker;
}
