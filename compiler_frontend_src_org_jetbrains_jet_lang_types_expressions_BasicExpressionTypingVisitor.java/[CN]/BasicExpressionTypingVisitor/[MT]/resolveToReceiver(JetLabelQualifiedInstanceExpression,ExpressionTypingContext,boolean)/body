{
  String labelName=expression.getLabelName();
  if (labelName != null) {
    LabelResolver.LabeledReceiverResolutionResult resolutionResult=context.labelResolver.resolveThisLabel(expression.getInstanceReference(),expression.getTargetLabel(),context,Name.identifierForLabel(labelName));
    if (onlyClassReceivers && resolutionResult.success()) {
      if (!isDeclaredInClass(resolutionResult.getReceiverParameterDescriptor())) {
        return LabelResolver.LabeledReceiverResolutionResult.labelResolutionSuccess(NO_RECEIVER_PARAMETER);
      }
    }
    return resolutionResult;
  }
 else {
    ReceiverParameterDescriptor result=NO_RECEIVER_PARAMETER;
    List<ReceiverParameterDescriptor> receivers=context.scope.getImplicitReceiversHierarchy();
    if (onlyClassReceivers) {
      for (      ReceiverParameterDescriptor receiver : receivers) {
        if (isDeclaredInClass(receiver)) {
          result=receiver;
          break;
        }
      }
    }
 else     if (!receivers.isEmpty()) {
      result=receivers.get(0);
    }
    if (result != NO_RECEIVER_PARAMETER) {
      context.trace.record(REFERENCE_TARGET,expression.getInstanceReference(),result.getContainingDeclaration());
      recordThisOrSuperCallInTraceAndCallExtension(context,result,expression);
    }
    return LabelResolver.LabeledReceiverResolutionResult.labelResolutionSuccess(result);
  }
}
