{
  List<ValueParameterDescriptor> paramDescrs=functionDescriptor.getValueParameters();
  List<TypeParameterDescriptor> typeParameters=(functionDescriptor instanceof PropertyAccessorDescriptor ? ((PropertyAccessorDescriptor)functionDescriptor).getCorrespondingProperty() : functionDescriptor).getTypeParameters();
  int flags=ACC_PUBLIC;
  OwnerKind kind=context.getContextKind();
  ReceiverDescriptor expectedThisObject=functionDescriptor.getExpectedThisObject();
  ReceiverDescriptor receiverParameter=functionDescriptor.getReceiverParameter();
  if (kind != OwnerKind.TRAIT_IMPL || bodyExpressions != null) {
    boolean isStatic=kind == OwnerKind.NAMESPACE;
    if (isStatic || kind == OwnerKind.TRAIT_IMPL)     flags|=ACC_STATIC;
    boolean isAbstract=!isStatic && !(kind == OwnerKind.TRAIT_IMPL) && (bodyExpressions == null || CodegenUtil.isInterface(functionDescriptor.getContainingDeclaration()));
    if (isAbstract)     flags|=ACC_ABSTRACT;
    final MethodVisitor mv=v.newMethod(fun,flags,jvmSignature.getName(),jvmSignature.getDescriptor(),null,null);
    if (v.generateCode()) {
      int start=0;
      if (kind != OwnerKind.TRAIT_IMPL) {
        AnnotationVisitor av=mv.visitAnnotation("Ljet/typeinfo/JetMethod;",true);
        if (functionDescriptor.getReturnType().isNullable()) {
          av.visit("nullableReturnType",true);
        }
        av.visitEnd();
      }
      if (kind == OwnerKind.TRAIT_IMPL) {
        AnnotationVisitor av=mv.visitParameterAnnotation(start++,"Ljet/typeinfo/JetParameter;",true);
        av.visit("value","this$self");
        av.visitEnd();
      }
      if (receiverParameter.exists()) {
        AnnotationVisitor av=mv.visitParameterAnnotation(start++,"Ljet/typeinfo/JetParameter;",true);
        av.visit("value","this$receiver");
        if (receiverParameter.getType().isNullable()) {
          av.visit("nullable",true);
        }
        av.visitEnd();
      }
      for (      final TypeParameterDescriptor typeParameterDescriptor : typeParameters) {
        AnnotationVisitor av=mv.visitParameterAnnotation(start++,"Ljet/typeinfo/JetTypeParameter;",true);
        av.visit("value",typeParameterDescriptor.getName());
        av.visitEnd();
      }
      for (int i=0; i != paramDescrs.size(); ++i) {
        AnnotationVisitor av=mv.visitParameterAnnotation(i + start,"Ljet/typeinfo/JetParameter;",true);
        ValueParameterDescriptor parameterDescriptor=paramDescrs.get(i);
        av.visit("name",parameterDescriptor.getName());
        if (parameterDescriptor.hasDefaultValue()) {
          av.visit("hasDefaultValue",true);
        }
        if (parameterDescriptor.getOutType().isNullable()) {
          av.visit("nullable",true);
        }
        av.visitEnd();
      }
    }
    if (!isAbstract && v.generateCode()) {
      mv.visitCode();
      Label methodBegin=new Label();
      mv.visitLabel(methodBegin);
      FrameMap frameMap=context.prepareFrame(typeMapper);
      ExpressionCodegen codegen=new ExpressionCodegen(mv,frameMap,jvmSignature.getReturnType(),context,state);
      Type[] argTypes=jvmSignature.getArgumentTypes();
      int add=0;
      if (kind == OwnerKind.TRAIT_IMPL)       add++;
      if (receiverParameter.exists())       add++;
      for (      final TypeParameterDescriptor typeParameterDescriptor : typeParameters) {
        int slot=frameMap.enterTemp();
        add++;
        codegen.addTypeParameter(typeParameterDescriptor,StackValue.local(slot,JetTypeMapper.TYPE_TYPEINFO));
      }
      for (int i=0; i < paramDescrs.size(); i++) {
        ValueParameterDescriptor parameter=paramDescrs.get(i);
        frameMap.enter(parameter,argTypes[i + add].getSize());
      }
      if (kind instanceof OwnerKind.DelegateKind) {
        OwnerKind.DelegateKind dk=(OwnerKind.DelegateKind)kind;
        InstructionAdapter iv=new InstructionAdapter(mv);
        iv.load(0,JetTypeMapper.TYPE_OBJECT);
        dk.getDelegate().put(JetTypeMapper.TYPE_OBJECT,iv);
        for (int i=0; i < argTypes.length; i++) {
          Type argType=argTypes[i];
          iv.load(i + 1,argType);
        }
        iv.invokeinterface(dk.getOwnerClass(),jvmSignature.getName(),jvmSignature.getDescriptor());
        iv.areturn(jvmSignature.getReturnType());
      }
 else {
        for (        ValueParameterDescriptor parameter : paramDescrs) {
          Type sharedVarType=typeMapper.getSharedVarType(parameter);
          if (sharedVarType != null) {
            Type localVarType=typeMapper.mapType(parameter.getOutType());
            int index=frameMap.getIndex(parameter);
            mv.visitTypeInsn(NEW,sharedVarType.getInternalName());
            mv.visitInsn(DUP);
            mv.visitInsn(DUP);
            mv.visitMethodInsn(INVOKESPECIAL,sharedVarType.getInternalName(),"<init>","()V");
            mv.visitVarInsn(localVarType.getOpcode(ILOAD),index);
            mv.visitFieldInsn(PUTFIELD,sharedVarType.getInternalName(),"ref",StackValue.refType(localVarType).getDescriptor());
            mv.visitVarInsn(sharedVarType.getOpcode(ISTORE),index);
          }
        }
        codegen.returnExpression(bodyExpressions);
      }
      Label methodEnd=new Label();
      mv.visitLabel(methodEnd);
      int k=0;
      if (expectedThisObject.exists()) {
        Type type=typeMapper.mapType(expectedThisObject.getType());
        mv.visitLocalVariable("this",type.getDescriptor(),null,methodBegin,methodEnd,k++);
      }
      if (receiverParameter.exists()) {
        Type type=typeMapper.mapType(receiverParameter.getType());
        mv.visitLocalVariable("this$receiver",type.getDescriptor(),null,methodBegin,methodEnd,k);
        k+=type.getSize();
      }
      for (      final TypeParameterDescriptor typeParameterDescriptor : typeParameters) {
        mv.visitLocalVariable(typeParameterDescriptor.getName(),JetTypeMapper.TYPE_TYPEINFO.getDescriptor(),null,methodBegin,methodEnd,k++);
      }
      for (      ValueParameterDescriptor parameter : paramDescrs) {
        Type type=typeMapper.mapType(parameter.getOutType());
        mv.visitLocalVariable(parameter.getName(),type.getDescriptor(),null,methodBegin,methodEnd,k);
        k+=type.getSize();
      }
      mv.visitMaxs(0,0);
      mv.visitEnd();
      generateBridgeIfNeeded(owner,state,v,jvmSignature,functionDescriptor,kind);
    }
  }
  generateDefaultIfNeeded(context,state,v,jvmSignature,functionDescriptor,kind);
}
