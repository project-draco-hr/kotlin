{
  List<JetElement> block=expression.getStatements();
  Function1<JetElement,Boolean> filter=getPartialBodyResolveProvider().getFilter();
  if (filter != null && !(expression instanceof JetPsiUtil.JetExpressionWrapper)) {
    block=KotlinPackage.filter(block,filter);
  }
  DeclarationDescriptor containingDescriptor=context.scope.getContainingDeclaration();
  if (containingDescriptor instanceof ScriptDescriptor) {
    if (!(expression.getParent() instanceof JetScript)) {
      containingDescriptor=((ScriptDescriptor)containingDescriptor).getScriptCodeDescriptor();
    }
  }
  WritableScope scope=new WritableScopeImpl(context.scope,containingDescriptor,new TraceBasedRedeclarationHandler(context.trace),"getBlockReturnedType");
  scope.changeLockLevel(WritableScope.LockLevel.BOTH);
  JetTypeInfo r;
  if (block.isEmpty()) {
    r=DataFlowUtils.checkType(builtIns.getUnitType(),expression,context,context.dataFlowInfo);
  }
 else {
    r=getBlockReturnedTypeWithWritableScope(scope,block,coercionStrategyForLastExpression,context,context.trace);
  }
  scope.changeLockLevel(WritableScope.LockLevel.READING);
  if (containingDescriptor instanceof ScriptDescriptor) {
    context.trace.record(BindingContext.SCRIPT_SCOPE,(ScriptDescriptor)containingDescriptor,scope);
  }
  return r;
}
