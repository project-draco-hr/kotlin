{
  if (d instanceof VariableDescriptor) {
    VariableDescriptor vd=(VariableDescriptor)d;
    EnclosedValueDescriptor answer=closure.get(vd);
    if (answer != null)     return answer.getInnerValue();
    final int idx=exprContext.lookupLocal(vd);
    if (idx < 0)     return null;
    final Type sharedVarType=exprContext.getSharedVarType(vd);
    Type localType=state.getTypeMapper().mapType(vd.getOutType());
    final Type type=sharedVarType != null ? sharedVarType : localType;
    StackValue outerValue=StackValue.local(idx,type);
    final String fieldName="$" + (closure.size() + 1);
    StackValue innerValue=sharedVarType != null ? StackValue.fieldForSharedVar(localType,name,fieldName) : StackValue.field(type,name,fieldName,false);
    cv.visitField(Opcodes.ACC_PUBLIC,fieldName,type.getDescriptor(),null,null);
    answer=new EnclosedValueDescriptor(d,innerValue,outerValue);
    closure.put(d,answer);
    return innerValue;
  }
  return null;
}
