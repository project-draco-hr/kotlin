{
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  prepareForCompilation(state);
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  MultiMap<FqName,JetFile> packageFqNameToFiles=new MultiMap<FqName,JetFile>();
  MultiMap<FqName,JetFile> multifileClassFqNameToFiles=new MultiMap<FqName,JetFile>();
  for (  JetFile file : state.getFiles()) {
    if (file == null)     throw new IllegalArgumentException("A null file given for compilation");
    JvmFileClassInfo fileClassInfo=state.getFileClassesProvider().getFileClassInfo(file);
    if (fileClassInfo.getIsMultifileClass()) {
      multifileClassFqNameToFiles.putValue(fileClassInfo.getFacadeClassFqName(),file);
    }
 else     if (state.getPackageFacadesAsMultifileClasses()) {
      multifileClassFqNameToFiles.putValue(PackageClassUtils.getPackageClassFqName(file.getPackageFqName()),file);
    }
 else {
      packageFqNameToFiles.putValue(file.getPackageFqName(),file);
    }
  }
  Set<FqName> packagesWithObsoleteParts=new HashSet<FqName>(state.getPackagesWithObsoleteParts());
  for (  FqName packageFqName : Sets.union(packagesWithObsoleteParts,packageFqNameToFiles.keySet())) {
    ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
    generatePackage(state,packageFqName,packageFqNameToFiles.get(packageFqName),errorHandler);
  }
  for (  FqName multifileClassFqName : multifileClassFqNameToFiles.keySet()) {
    ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
    generateMultifileClass(state,multifileClassFqName,multifileClassFqNameToFiles.get(multifileClassFqName),errorHandler);
  }
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  state.getFactory().done();
}
