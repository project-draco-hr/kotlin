{
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  prepareForCompilation(state);
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  MultiMap<FqName,JetFile> packageFqNameToFiles=new MultiMap<FqName,JetFile>();
  for (  JetFile file : state.getFiles()) {
    if (file == null)     throw new IllegalArgumentException("A null file given for compilation");
    packageFqNameToFiles.putValue(file.getPackageFqName(),file);
  }
  Set<FqName> packagesWithObsoleteParts=new HashSet<FqName>(state.getPackagesWithObsoleteParts());
  for (  FqName fqName : Sets.union(packagesWithObsoleteParts,packageFqNameToFiles.keySet())) {
    ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
    generatePackage(state,fqName,packageFqNameToFiles.get(fqName),errorHandler);
  }
  ProgressIndicatorAndCompilationCanceledStatus.checkCanceled();
  state.getFactory().done();
}
