{
  prepareForCompilation(state);
  MultiMap<FqName,JetFile> packageFqNameToFiles=new MultiMap<FqName,JetFile>();
  for (  JetFile file : state.getFiles()) {
    if (file == null)     throw new IllegalArgumentException("A null file given for compilation");
    packageFqNameToFiles.putValue(file.getPackageFqName(),file);
  }
  Set<FqName> removedPackageFiles=new HashSet<FqName>(state.getPackagesWithRemovedFiles());
  for (  FqName fqName : Sets.union(removedPackageFiles,packageFqNameToFiles.keySet())) {
    generatePackage(state,fqName,packageFqNameToFiles.get(fqName),errorHandler);
  }
  state.getFactory().done();
}
