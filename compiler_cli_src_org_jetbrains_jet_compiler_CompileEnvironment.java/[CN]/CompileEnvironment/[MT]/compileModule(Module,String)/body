{
  CompileSession moduleCompileSession=newCompileSession();
  moduleCompileSession.setStubs(stubs);
  if (moduleBuilder.getSourceFiles().isEmpty()) {
    throw new CompileEnvironmentException("No source files where defined");
  }
  for (  String sourceFile : moduleBuilder.getSourceFiles()) {
    File source=new File(sourceFile);
    if (!source.isAbsolute()) {
      source=new File(directory,sourceFile);
    }
    if (!source.exists()) {
      throw new CompileEnvironmentException("'" + source + "' does not exist");
    }
    moduleCompileSession.addSources(source.getPath());
  }
  for (  String classpathRoot : moduleBuilder.getClasspathRoots()) {
    environment.addToClasspath(new File(classpathRoot));
  }
  ensureRuntime();
  if (!moduleCompileSession.analyze() && !ignoreErrors) {
    return null;
  }
  return moduleCompileSession.generate(false).getFactory();
}
