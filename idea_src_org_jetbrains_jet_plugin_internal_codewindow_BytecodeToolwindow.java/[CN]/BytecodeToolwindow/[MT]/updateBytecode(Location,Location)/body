{
  Editor editor=location.editor;
  if (editor == null) {
    setText("");
  }
 else {
    VirtualFile vFile=((EditorEx)editor).getVirtualFile();
    if (vFile == null) {
      setText("");
      return;
    }
    PsiFile psiFile=PsiManager.getInstance(myProject).findFile(vFile);
    if (!(psiFile instanceof JetFile)) {
      setText("");
      return;
    }
    if (oldLocation == null || !Comparing.equal(oldLocation.editor,location.editor) || oldLocation.modificationStamp != location.modificationStamp) {
      setText(generateToText((JetFile)psiFile));
    }
    Document document=editor.getDocument();
    int startLine=document.getLineNumber(location.startOffset);
    int endLine=document.getLineNumber(location.endOffset);
    if (endLine > startLine && location.endOffset > 0 && document.getCharsSequence().charAt(location.endOffset - 1) == '\n')     endLine--;
    Document byteCodeDocument=myEditor.getDocument();
    Pair<Integer,Integer> linesRange=mapLines(byteCodeDocument.getText(),startLine,endLine);
    int endSelectionLineIndex=Math.min(linesRange.second + 1,byteCodeDocument.getLineCount());
    int startOffset=byteCodeDocument.getLineStartOffset(linesRange.first);
    int endOffset=Math.min(byteCodeDocument.getLineStartOffset(endSelectionLineIndex),byteCodeDocument.getTextLength());
    myEditor.getCaretModel().moveToOffset(endOffset);
    myEditor.getScrollingModel().scrollToCaret(ScrollType.MAKE_VISIBLE);
    myEditor.getCaretModel().moveToOffset(startOffset);
    myEditor.getScrollingModel().scrollToCaret(ScrollType.MAKE_VISIBLE);
    myEditor.getSelectionModel().setSelection(startOffset,endOffset);
  }
}
