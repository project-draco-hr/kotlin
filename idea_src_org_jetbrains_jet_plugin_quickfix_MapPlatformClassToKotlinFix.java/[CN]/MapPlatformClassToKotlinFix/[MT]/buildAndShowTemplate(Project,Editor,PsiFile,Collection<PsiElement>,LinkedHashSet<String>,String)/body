{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(editor.getDocument());
  PsiElement primaryReplacedExpression=replaceElements.iterator().next();
  final CaretModel caretModel=editor.getCaretModel();
  final int oldOffset=caretModel.getOffset();
  caretModel.moveToOffset(file.getNode().getStartOffset());
  TemplateBuilderImpl builder=new TemplateBuilderImpl(file);
  Expression expression=new MyLookupExpression(primaryReplacedExpression.getText(),options,null,false,advertisement);
  builder.replaceElement(primaryReplacedExpression,PRIMARY_USAGE,expression,true);
  for (  PsiElement replacedExpression : replaceElements) {
    if (replacedExpression == primaryReplacedExpression)     continue;
    builder.replaceElement(replacedExpression,OTHER_USAGE,PRIMARY_USAGE,false);
  }
  TemplateManager.getInstance(project).startTemplate(editor,builder.buildInlineTemplate(),new TemplateEditingAdapter(){
    @Override public void templateFinished(    Template template,    boolean brokenOff){
      caretModel.moveToOffset(oldOffset);
    }
  }
);
}
