{
  Type known=knowTypes.get(jetType);
  if (known != null) {
    if (kind == MapTypeMode.VALUE) {
      return mapKnownAsmType(jetType,known,signatureVisitor,false);
    }
 else     if (kind == MapTypeMode.TYPE_PARAMETER) {
      return mapKnownAsmType(jetType,known,signatureVisitor,true);
    }
 else     if (kind == MapTypeMode.TRAIT_IMPL) {
      throw new IllegalStateException("TRAIT_IMPL is not possible for " + jetType);
    }
 else     if (kind == MapTypeMode.IMPL) {
      if (compilerSpecialMode != CompilerSpecialMode.BUILTINS) {
      }
    }
 else {
      throw new IllegalStateException("unknown kind: " + kind);
    }
  }
  DeclarationDescriptor descriptor=jetType.getConstructor().getDeclarationDescriptor();
  if (ErrorUtils.isError(descriptor)) {
    Type asmType=Type.getObjectType("error/NonExistentClass");
    if (signatureVisitor != null) {
      visitAsmType(signatureVisitor,asmType,true);
    }
    return asmType;
  }
  if (standardLibrary.getArray().equals(descriptor)) {
    if (jetType.getArguments().size() != 1) {
      throw new UnsupportedOperationException("arrays must have one type argument");
    }
    JetType memberType=jetType.getArguments().get(0).getType();
    if (signatureVisitor != null) {
      signatureVisitor.writeArrayType(jetType.isNullable());
      mapType(memberType,signatureVisitor,MapTypeMode.TYPE_PARAMETER);
      signatureVisitor.writeArrayEnd();
    }
    if (!isGenericsArray(jetType)) {
      return Type.getType("[" + boxType(mapType(memberType,kind)).getDescriptor());
    }
 else {
      return ARRAY_GENERIC_TYPE;
    }
  }
  if (JetStandardClasses.getAny().equals(descriptor)) {
    if (signatureVisitor != null) {
      visitAsmType(signatureVisitor,TYPE_OBJECT,jetType.isNullable());
    }
    return TYPE_OBJECT;
  }
  if (descriptor instanceof ClassDescriptor) {
    Type asmType;
    boolean forceReal;
    if (standardLibrary.getComparable().equals(descriptor)) {
      if (jetType.getArguments().size() != 1) {
        throw new UnsupportedOperationException("Comparable must have one type argument");
      }
      asmType=JL_COMPARABLE_TYPE;
      forceReal=false;
    }
 else {
      JvmClassName name=getClassFQName((ClassDescriptor)descriptor);
      asmType=Type.getObjectType(name.getInternalName() + (kind == MapTypeMode.TRAIT_IMPL ? JvmAbi.TRAIT_IMPL_SUFFIX : ""));
      forceReal=isForceReal(name);
    }
    if (signatureVisitor != null) {
      signatureVisitor.writeClassBegin(asmType.getInternalName(),jetType.isNullable(),forceReal);
      for (      TypeProjection proj : jetType.getArguments()) {
        signatureVisitor.writeTypeArgument(proj.getProjectionKind());
        mapType(proj.getType(),signatureVisitor,MapTypeMode.TYPE_PARAMETER);
        signatureVisitor.writeTypeArgumentEnd();
      }
      signatureVisitor.writeClassEnd();
    }
    return asmType;
  }
  if (descriptor instanceof TypeParameterDescriptor) {
    Type type=mapType(((TypeParameterDescriptor)descriptor).getUpperBoundsAsType(),kind);
    if (signatureVisitor != null) {
      TypeParameterDescriptor typeParameterDescriptor=(TypeParameterDescriptor)jetType.getConstructor().getDeclarationDescriptor();
      signatureVisitor.writeTypeVariable(typeParameterDescriptor.getName(),jetType.isNullable(),type);
    }
    return type;
  }
  throw new UnsupportedOperationException("Unknown type " + jetType);
}
