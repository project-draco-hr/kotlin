{
  out.println(graphHeader + " {");
  final Map<Instruction,String> nodeToName=new HashMap<Instruction,String>();
  for (  Instruction node : instructions) {
    if (node instanceof UnconditionalJumpInstruction) {
      continue;
    }
    String name="n" + count[0]++;
    nodeToName.put(node,name);
    String text=node.toString();
    int newline=text.indexOf("\n");
    if (newline >= 0) {
      text=text.substring(0,newline);
    }
    String shape="box";
    if (node instanceof ConditionalJumpInstruction) {
      shape="diamond";
    }
 else     if (node instanceof NondeterministicJumpInstruction) {
      shape="Mdiamond";
    }
 else     if (node instanceof UnsupportedElementInstruction) {
      shape="box, fillcolor=red, style=filled";
    }
 else     if (node instanceof FunctionLiteralValueInstruction) {
      shape="Mcircle";
    }
    out.println(name + "[label=\"" + text+ "\", shape="+ shape+ "];");
  }
  for (  final Instruction fromInst : instructions) {
    fromInst.accept(new InstructionVisitor(){
      @Override public void visitFunctionLiteralValue(      FunctionLiteralValueInstruction instruction){
        int index=count[0];
        instruction.getBody().dumpSubgraph(out,"subgraph f" + index,count,"color=blue;\ntlabel = \"process #" + index + "\";");
        printEdge(out,nodeToName.get(instruction),"n" + index,null);
        visitInstructionWithNext(instruction);
      }
      @Override public void visitUnconditionalJump(      UnconditionalJumpInstruction instruction){
      }
      @Override public void visitJump(      AbstractJumpInstruction instruction){
        printEdge(out,nodeToName.get(instruction),nodeToName.get(instruction.getResolvedTarget()),null);
      }
      @Override public void visitNondeterministicJump(      NondeterministicJumpInstruction instruction){
        visitJump(instruction);
        printEdge(out,nodeToName.get(instruction),nodeToName.get(instruction.getNext()),null);
      }
      @Override public void visitReturnValue(      ReturnValueInstruction instruction){
        super.visitReturnValue(instruction);
      }
      @Override public void visitReturnNoValue(      ReturnNoValueInstruction instruction){
        super.visitReturnNoValue(instruction);
      }
      @Override public void visitConditionalJump(      ConditionalJumpInstruction instruction){
        String from=nodeToName.get(instruction);
        printEdge(out,from,nodeToName.get(instruction.getNextOnFalse()),"no");
        printEdge(out,from,nodeToName.get(instruction.getNextOnTrue()),"yes");
      }
      @Override public void visitInstructionWithNext(      InstructionWithNext instruction){
        printEdge(out,nodeToName.get(instruction),nodeToName.get(instruction.getNext()),null);
      }
      @Override public void visitSubroutineExit(      SubroutineExitInstruction instruction){
      }
      @Override public void visitInstruction(      Instruction instruction){
        throw new UnsupportedOperationException(instruction.toString());
      }
    }
);
  }
  out.println(style);
  out.println("}");
}
