{
  PsiReference reference=file.findReferenceAt(refOffset);
  if (reference instanceof JetReference) {
    PsiElement target=reference.resolve();
    if (target != null) {
      boolean same=file.getManager().areElementsEquivalent(target,targetElement);
      if (!same) {
        same=target instanceof PsiClass && importFqn.asString().equals(((PsiClass)target).getQualifiedName());
      }
      if (!same) {
        if (target instanceof PsiMethod) {
          PsiMethod method=(PsiMethod)target;
          same=(method.isConstructor() && file.getManager().areElementsEquivalent(method.getContainingClass(),targetElement));
        }
      }
      if (!same) {
        if (target instanceof JetObjectDeclarationName) {
          same=file.getManager().areElementsEquivalent(target.getParent(),targetElement);
        }
      }
      if (!same) {
        Document document=PsiDocumentManager.getInstance(file.getProject()).getDocument(file);
        TextRange refRange=reference.getElement().getTextRange();
        document.replaceString(refRange.getStartOffset(),refRange.getEndOffset(),importFqn.asString());
      }
      return;
    }
  }
  addImportDirectiveIfNeeded(importFqn,file);
}
