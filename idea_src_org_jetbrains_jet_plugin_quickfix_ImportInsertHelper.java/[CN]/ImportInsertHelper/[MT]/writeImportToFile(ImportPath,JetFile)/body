{
  JetPsiFactory psiFactory=JetPsiFactory(file.getProject());
  if (file instanceof JetCodeFragment) {
    JetImportDirective newDirective=psiFactory.createImportDirective(importPath);
    ((JetCodeFragment)file).addImportsFromString(newDirective.getText());
    return;
  }
  JetImportList importList=file.getImportList();
  if (importList != null) {
    JetImportDirective newDirective=psiFactory.createImportDirective(importPath);
    importList.add(psiFactory.createNewLine());
    importList.add(newDirective);
  }
 else {
    JetImportList newDirective=psiFactory.createImportDirectiveWithImportList(importPath);
    JetPackageDirective packageDirective=file.getPackageDirective();
    if (packageDirective == null) {
      throw new IllegalStateException("Scripts are not supported: " + file.getName());
    }
    packageDirective.getParent().addAfter(newDirective,packageDirective);
  }
}
